<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APP Agendei7</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind CSS Config -->
    <script>
      tailwind.config = {
        darkMode: 'class'
      }
    </script>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PWA Manifest -->
    <link rel="manifest" id="manifest">

    <!-- Theme Color -->
    <meta name="theme-color" content="#6d28d9">

    <!-- Icons -->
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <style>
        /* Estilo para a anima√ß√£o de carregamento */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #6d28d9;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Anima√ß√£o para o Modal */
        @keyframes fade-in-scale {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-fade-in-scale {
            animation: fade-in-scale 0.2s ease-out forwards;
        }

        /* Anima√ß√£o para o Toast */
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
        .animate-fade-in-out {
            animation: fade-in-out 3s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

// --- Componente Modal de Notifica√ß√£o Avan√ßado ---
const AdvancedNotificationModal = ({ isOpen, departmentName, onClose, onSend }) => {
    const [message, setMessage] = useState('');
    const [sendEmail, setSendEmail] = useState(true);
    const [sendMural, setSendMural] = useState(true);
    const [isSending, setIsSending] = useState(false);
    const [sentSuccess, setSentSuccess] = useState(false);

    useEffect(() => {
        if (isOpen) {
            setMessage(`Ol√° lideran√ßa do ${departmentName}, aguardamos sua escala para a data selecionada. Gra√ßa e Paz!`);
            setSentSuccess(false);
            setIsSending(false);
        }
    }, [isOpen, departmentName]);

    const handleSendClick = () => {
        if (!sendEmail && !sendMural) {
            alert("Selecione pelo menos uma forma de envio.");
            return;
        }
        setIsSending(true);
        
        // Simula√ß√£o de envio (Anima√ß√£o)
        setTimeout(() => {
            setIsSending(false);
            setSentSuccess(true);
            setTimeout(() => {
                onSend({ message, sendEmail, sendMural });
                onClose();
            }, 1500);
        }, 2000);
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 animate-fade-in-scale">
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md relative overflow-hidden">
                
                {/* Tela de Sucesso P√≥s-Envio */}
                {sentSuccess ? (
                    <div className="flex flex-col items-center justify-center py-8 animate-fade-in-scale">
                        <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                        </div>
                        <h3 className="text-xl font-bold text-gray-800 dark:text-white">Notifica√ß√£o Enviada!</h3>
                        <p className="text-gray-500 text-sm mt-2">O departamento foi notificado com sucesso.</p>
                    </div>
                ) : (
                    <>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-800 dark:text-gray-200">Notificar {departmentName}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                        </div>

                        <div className="mb-4">
                            <label className="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Mensagem Personalizada</label>
                            <textarea 
                                value={message} 
                                onChange={(e) => setMessage(e.target.value)}
                                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-violet-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm"
                                rows="3"
                            ></textarea>
                        </div>

                        <div className="mb-6 space-y-3">
                            <p className="text-sm font-semibold text-gray-700 dark:text-gray-300">Canais de Envio:</p>
                            <label className="flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 dark:border-gray-600">
                                <input type="checkbox" checked={sendEmail} onChange={(e) => setSendEmail(e.target.checked)} className="h-5 w-5 text-violet-600 rounded focus:ring-violet-500" />
                                <div className="flex items-center text-gray-700 dark:text-gray-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg>
                                    <span>Enviar por E-mail</span>
                                </div>
                            </label>
                            <label className="flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 dark:border-gray-600">
                                <input type="checkbox" checked={sendMural} onChange={(e) => setSendMural(e.target.checked)} className="h-5 w-5 text-violet-600 rounded focus:ring-violet-500" />
                                <div className="flex items-center text-gray-700 dark:text-gray-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2 text-orange-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" /></svg>
                                    <span>Mural do App (In√≠cio)</span>
                                </div>
                            </label>
                        </div>

                        <button 
                            onClick={handleSendClick} 
                            disabled={isSending}
                            className={`w-full font-bold py-3 px-4 rounded-lg transition flex justify-center items-center gap-2 ${isSending ? 'bg-gray-400 cursor-not-allowed' : 'bg-violet-600 hover:bg-violet-700 text-white'}`}
                        >
                            {isSending ? (
                                <>
                                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                    Enviando...
                                </>
                            ) : (
                                <>
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                                    Enviar Notifica√ß√£o
                                </>
                            )}
                        </button>
                    </>
                )}
            </div>
        </div>
    );
};


// Fun√ß√£o auxiliar base64
const fileToBase64 = (file) => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = error => reject(error);
});

const getDriveDirectImage = (url) => {
    if (!url) return '';
    // Regex para extrair o ID do arquivo entre '/d/' e '/'
    const match = url.match(/\/d\/(.+?)(\/|$)/);
    if (match && match[1]) {
        // Retorna a API de Thumbnail do Google Drive
        // sz=w1000 for√ßa uma largura de 1000px (alta qualidade)
        return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w1000`;
    }
    return url;
};

const NotificationCenterModal = ({ isOpen, onClose, mockDepartments = {} }) => {
    // ... (Estados iniciais mantidos iguais)
    const [activeTab, setActiveTab] = useState('central'); 
    const [viewMode, setViewMode] = useState('feed');
    const [showFilter, setShowFilter] = useState(false);
    const [showEditor, setShowEditor] = useState(false);
    const [isPosting, setIsPosting] = useState(false);
    const [isLoadingFeed, setIsLoadingFeed] = useState(false);
    const [feedError, setFeedError] = useState(null);

    // Editor
    const [editorTitle, setEditorTitle] = useState('');
    const [editorText, setEditorText] = useState('');
    const [editorPriority, setEditorPriority] = useState('normal');
    const [attachment, setAttachment] = useState(null); 
    
    const [posts, setPosts] = useState([]); 
    const [filterKeyword, setFilterKeyword] = useState('');
    const [filterDept, setFilterDept] = useState('Todos');
    const [filterDate, setFilterDate] = useState('');
    const fileInputRef = useRef(null);

    // --- CORRE√á√ÉO: USAR API GLOBAL EM VEZ DE FETCH ---
    // Removemos a fun√ß√£o 'safeFetch' antiga e usamos api._callApi diretamente
    
    // --- 1. CARREGAR DADOS DO BACKEND ---
    const fetchPosts = async () => {
        setIsLoadingFeed(true);
        setFeedError(null);
        try {
            // AQUI ESTAVA O ERRO: Trocamos safeFetch por api.getMuralPosts()
            // ou api._callApi('getMuralPosts')
            const data = await api.getMuralPosts(); 
            
            // Como nossa api._callApi j√° trata o erro e retorna response.data se sucesso,
            // 'data' aqui j√° √© o array de posts.
            if (Array.isArray(data)) {
                setPosts(data);
            } else {
                // Caso venha algo diferente (ex: objeto vazio)
                setPosts([]);
            }
        } catch (error) {
            console.error("Erro ao carregar feed:", error);
            setFeedError("Falha na conex√£o com o servidor.");
        } finally {
            setIsLoadingFeed(false);
        }
    };

    useEffect(() => {
        if (isOpen && activeTab === 'central') {
            fetchPosts();
        }
    }, [isOpen, activeTab]);

    // --- 2. GALERIA DE ARQUIVOS (Via Planilha) ---
    const muralFiles = useMemo(() => {
        return posts
            .filter(p => p.file && p.file.url)
            .map(p => ({
                id: p.id,
                name: p.file.name,
                url: p.file.url,
                type: p.file.type,
                displayType: (p.file.type && p.file.type.toUpperCase().includes('IMAGE')) ? 'IMG' : 'DOC',
                date: p.date,
                user: p.user
            }));
    }, [posts]);

    // --- 3. PUBLICAR ---
    const handlePostMessage = async () => {
        if (!editorText.trim() || !editorTitle.trim()) return alert("Preencha t√≠tulo e mensagem.");
        
        setIsPosting(true);
        let base64Data = null;
        try {
            if (attachment) base64Data = await fileToBase64(attachment);

            const payload = {
                title: editorTitle,
                content: editorText,
                priority: editorPriority,
                fileData: base64Data,
                fileName: attachment ? attachment.name : null,
                fileMimeType: attachment ? attachment.type : null,
                user: 'Admin'
            };

            // AQUI TAMB√âM: Trocamos safeFetch por api.publishMuralPost
            await api.publishMuralPost(payload);

            // Se chegou aqui, sucesso!
            resetEditor();
            setShowEditor(false);
            setViewMode('feed');
            // Recarrega o feed para mostrar o post novo
            setTimeout(fetchPosts, 1000);

        } catch (error) {
            console.error("Erro na publica√ß√£o:", error);
            alert("Erro ao publicar: " + error.message);
        } finally {
            setIsPosting(false);
        }
    };

    const resetEditor = () => {
        setEditorText(''); setEditorTitle(''); setEditorPriority('normal'); setAttachment(null);
        if (fileInputRef.current) fileInputRef.current.value = "";
    };
    const handleAttachClick = () => fileInputRef.current.click();
    const handleFileChange = (e) => { if (e.target.files[0]) setAttachment(e.target.files[0]); };

    // ... (Helpers de cores, labels e filtros mantidos iguais) ...
    const getPriorityColor = (p) => {
        if(p==='critical') return 'bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-800';
        if(p==='high') return 'bg-orange-50 border-orange-200 dark:bg-orange-900/20 dark:border-orange-800';
        if(p==='low') return 'bg-green-50 border-green-200 dark:bg-green-900/20 dark:border-green-800';
        return 'bg-blue-50 border-blue-200 dark:bg-blue-900/20 dark:border-blue-800';
    };
    const getPriorityBadge = (p) => {
        if(p==='critical') return 'bg-red-500 text-white';
        if(p==='high') return 'bg-orange-500 text-white';
        if(p==='low') return 'bg-green-500 text-white';
        return 'bg-blue-500 text-white';
    };
    const getPriorityLabel = (p) => {
        if(p==='critical') return 'URGENTE';
        if(p==='high') return 'IMPORTANTE';
        if(p==='low') return 'INFORMATIVO';
        return 'AVISO';
    };

    const filteredPosts = posts.filter(post => {
        const matchesKeyword = post.content.toLowerCase().includes(filterKeyword.toLowerCase()) || post.title.toLowerCase().includes(filterKeyword.toLowerCase());
        const matchesDept = filterDept === 'Todos' || post.user.includes(filterDept);
        return matchesKeyword && matchesDept;
    });

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 backdrop-blur-sm animate-fade-in">
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] flex overflow-hidden relative">
                
                {/* Sidebar */}
                <aside className="w-20 md:w-64 bg-gray-100 dark:bg-gray-900 border-r border-gray-200 dark:border-gray-700 flex flex-col flex-shrink-0">
                    <div className="p-6 flex items-center justify-center md:justify-start gap-3 border-b dark:border-gray-800">
                        <div className="w-8 h-8 bg-violet-600 rounded-lg flex items-center justify-center text-white font-bold">A7</div>
                        <span className="font-bold text-gray-700 dark:text-gray-200 hidden md:block">Comunidade</span>
                    </div>
                    <nav className="flex-1 p-4 space-y-2">
                        <button onClick={() => setActiveTab('central')} className={`w-full flex items-center gap-3 p-3 rounded-xl transition ${activeTab === 'central' ? 'bg-violet-600 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-200 dark:text-gray-400 dark:hover:bg-gray-800'}`}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" /></svg>
                            <span className="hidden md:block font-medium">Central de Avisos</span>
                        </button>
                        <button onClick={() => setActiveTab('groups')} className={`w-full flex items-center gap-3 p-3 rounded-xl transition ${activeTab === 'groups' ? 'bg-violet-600 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-200 dark:text-gray-400 dark:hover:bg-gray-800'}`}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                            <span className="hidden md:block font-medium">Grupos</span>
                        </button>
                         <button onClick={() => setActiveTab('chat')} className={`w-full flex items-center gap-3 p-3 rounded-xl transition ${activeTab === 'chat' ? 'bg-violet-600 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-200 dark:text-gray-400 dark:hover:bg-gray-800'}`}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                            <span className="hidden md:block font-medium">Chat</span>
                        </button>
                    </nav>
                    <div className="p-4 border-t dark:border-gray-800">
                        <button onClick={onClose} className="w-full flex items-center justify-center gap-2 p-2 text-red-500 hover:bg-red-50 rounded-lg transition">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                            <span className="hidden md:block font-semibold">Sair</span>
                        </button>
                    </div>
                </aside>

                <main className="flex-1 bg-white dark:bg-gray-800 p-6 relative flex flex-col min-w-0">
                    <button onClick={onClose} className="absolute top-4 right-4 md:hidden text-gray-500 z-20">X</button>

                    {activeTab === 'central' && (
                        <div className="flex flex-col h-full relative">
                            {/* Header */}
                            <div className="border-b dark:border-gray-700 pb-4 mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
                                <div>
                                    <h3 className="text-2xl font-bold text-gray-800 dark:text-gray-200">Central de Avisos</h3>
                                    <p className="text-sm text-gray-500">Mural digital da igreja.</p>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setViewMode(viewMode === 'feed' ? 'files' : 'feed')} className={`px-4 py-2 border-2 rounded-lg text-xs font-bold transition flex items-center gap-2 ${viewMode === 'files' ? 'bg-red-50 border-red-500 text-red-600' : 'border-red-500 text-red-600 hover:bg-red-50'}`}>
                                            {viewMode === 'feed' ? 'üìÅ Arquivos' : 'üì∞ Voltar ao Mural'}
                                    </button>
                                    {viewMode === 'feed' && (
                                        <button onClick={() => setShowFilter(!showFilter)} className="px-4 py-2 border-2 border-red-500 text-red-600 rounded-lg text-xs font-bold hover:bg-red-50 transition">
                                            üîç Filtrar
                                        </button>
                                    )}
                                </div>
                            </div>

                            {/* Filtros */}
                            {showFilter && viewMode === 'feed' && (
                                <div className="bg-gray-100 dark:bg-gray-700/50 p-4 rounded-lg mb-4 border border-gray-200 animate-fade-in-scale">
                                    <div className="grid grid-cols-1 sm:grid-cols-4 gap-3 items-end">
                                        <div><label className="block text-xs font-bold mb-1">Busca</label><input type="text" value={filterKeyword} onChange={e => setFilterKeyword(e.target.value)} className="w-full p-2 text-sm border rounded" /></div>
                                        <div><label className="block text-xs font-bold mb-1">Depto</label><select value={filterDept} onChange={e => setFilterDept(e.target.value)} className="w-full p-2 text-sm border rounded"><option value="Todos">Todos</option>{Object.values(mockDepartments).map(d => <option key={d.DE_ID_DEPTO} value={d.DE_NOME_DEPARTAMENTO}>{d.DE_NOME_DEPARTAMENTO}</option>)}</select></div>
                                        <div><label className="block text-xs font-bold mb-1">Data</label><input type="date" value={filterDate} onChange={e => setFilterDate(e.target.value)} className="w-full p-2 text-sm border rounded" /></div>
                                        <button onClick={() => alert('Filtro Aplicado!')} className="bg-violet-600 text-white text-xs font-bold px-4 py-2 rounded h-10">Buscar</button>
                                    </div>
                                </div>
                            )}

                            {/* CONTE√öDO PRINCIPAL */}
                            <div className="flex-1 overflow-y-auto pr-2 space-y-4 pb-20">
                                {isLoadingFeed ? (
                                     <div className="flex justify-center p-10 text-gray-500"><span className="animate-spin mr-2">‚è≥</span> Carregando mural...</div>
                                ) : feedError ? (
                                    <div className="text-center text-gray-500 p-4">
                                        <p className="mb-2">N√£o foi poss√≠vel carregar o mural.</p>
                                        <button onClick={fetchPosts} className="text-violet-600 underline">Tentar novamente</button>
                                    </div>
                                ) : viewMode === 'files' ? (
                                    /* GALERIA DE ARQUIVOS */
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {muralFiles.length === 0 ? <p className="col-span-4 text-center text-gray-400">Sem arquivos no mural.</p> : muralFiles.map(file => (
                                            <a href={file.url} target="_blank" key={file.id} className="block border p-4 rounded-xl hover:shadow-md text-center bg-gray-50">
                                                <div className="text-2xl mb-2 font-bold text-gray-600">{file.displayType}</div>
                                                <p className="font-bold text-sm truncate">{file.name}</p>
                                                <p className="text-xs text-gray-500">{file.date}</p>
                                            </a>
                                        ))}
                                    </div>
                                ) : (
                                    /* FEED DE POSTAGENS */
                                    filteredPosts.length === 0 ? <p className="text-center text-gray-400 py-10">Nenhum aviso encontrado.</p> :
                                    filteredPosts.map(post => (
                                        <div key={post.id} className={`border p-4 rounded-xl ${getPriorityColor(post.priority)} bg-opacity-30`}>
                                            <div className="flex justify-between mb-2">
                                                <div className="flex gap-3 items-center">
                                                    <div className="w-10 h-10 rounded-full bg-white/50 flex items-center justify-center font-bold text-xs">{post.avatar}</div>
                                                    <div>
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-[10px] font-bold px-2 py-0.5 rounded-full bg-white/60 border">{getPriorityLabel(post.priority)}</span>
                                                            <span className="font-bold text-sm">{post.title}</span>
                                                        </div>
                                                        <p className="text-xs opacity-75">{post.user} ‚Ä¢ {post.date}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <p className="text-sm whitespace-pre-wrap">{post.content}</p>
                                            {post.file && post.file.url && (
                                                <div className="mt-3">
                                                    {post.file.type && post.file.type.toUpperCase().includes('IMAGE') ? (
                                                      /* IMAGEM COM LINK PARA O DRIVE */
                                                      <a href={post.file.url} target="_blank" rel="noopener noreferrer" className="block mt-2 group relative max-w-sm">
                                                          <img 
                                                              src={getDriveDirectImage(post.file.url)} 
                                                              alt="Anexo" 
                                                              referrerPolicy="no-referrer"  // <--- ADICIONE ISSO (Vital para imagens do Google)
                                                              className="rounded-lg border w-full object-cover hover:opacity-90 transition shadow-sm"
                                                              onError={(e) => {
                                                                  // Evita loop infinito se a imagem falhar
                                                                  e.target.onerror = null; 
                                                                  // Mostra um placeholder amig√°vel se falhar
                                                                  e.target.style.display = 'none'; 
                                                                  e.target.parentNode.innerHTML += '<div class="p-4 bg-gray-100 text-gray-500 text-xs rounded border text-center">Imagem n√£o dispon√≠vel (Clique para ver)</div>';
                                                              }}
                                                          />
                                                          {/* Pequeno √≠cone indicando que √© clic√°vel */}
                                                          <div className="absolute bottom-2 right-2 bg-black/50 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition text-xs">
                                                              Ver no Drive ‚Üó
                                                          </div>
                                                      </a>
                                                  ) : (
                                                      /* OUTROS ARQUIVOS (PDF, DOC, ETC) */
                                                      <a href={post.file.url} target="_blank" className="flex items-center gap-2 text-xs font-bold hover:underline bg-gray-50 p-2 rounded border mt-2 w-fit">
                                                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                          </svg>
                                                          {post.file.name}
                                                      </a>
                                                  )}
                                                </div>
                                            )}
                                        </div>
                                    ))
                                )}
                            </div>

                            {/* Bot√£o Flutuante */}
                            {viewMode === 'feed' && !showEditor && (
                                <button onClick={() => setShowEditor(true)} className="absolute bottom-6 right-6 shadow-xl bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full flex items-center gap-2 transition hover:scale-105 z-20">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                    Escrever Aviso
                                </button>
                            )}

                            {/* Editor */}
                            {showEditor && (
                                <div className="absolute bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t p-4 shadow-2xl z-30 animate-fade-in-up rounded-t-2xl">
                                    <div className="flex justify-between mb-3">
                                        <h4 className="font-bold text-gray-700 dark:text-gray-200">Novo Aviso</h4>
                                        <button onClick={() => setShowEditor(false)} className="text-gray-400 hover:text-red-500 text-xl">√ó</button>
                                    </div>
                                    <input type="text" className="w-full p-2 mb-2 border rounded font-bold text-sm" placeholder="T√≠tulo do Aviso" value={editorTitle} onChange={e => setEditorTitle(e.target.value)} />
                                    <div className="flex gap-2 mb-2 items-center">
                                        <select value={editorPriority} onChange={e => setEditorPriority(e.target.value)} className="text-xs p-1 border rounded">
                                            <option value="low">üü¢ Informativo</option>
                                            <option value="normal">üîµ Normal</option>
                                            <option value="high">üü† Importante</option>
                                            <option value="critical">üî¥ Urgente</option>
                                        </select>
                                        <button onClick={handleAttachClick} className="text-xs flex items-center gap-1 bg-gray-100 hover:bg-gray-200 p-1.5 rounded transition border">
                                            üìé {attachment ? attachment.name.substring(0, 15) + '...' : 'Anexar Arquivo'}
                                        </button>
                                        <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" />
                                    </div>
                                    <textarea className="w-full p-3 border rounded-lg h-24 text-sm resize-none focus:ring-2 focus:ring-violet-500" placeholder="Escreva sua mensagem aqui..." value={editorText} onChange={e => setEditorText(e.target.value)}></textarea>
                                    <div className="mt-3 flex justify-end">
                                        <button onClick={handlePostMessage} disabled={isPosting} className="bg-violet-600 hover:bg-violet-700 text-white px-6 py-2 rounded-lg font-bold text-sm transition shadow-md disabled:opacity-50">
                                            {isPosting ? 'Publicando...' : 'Publicar no Mural'}
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    {activeTab === 'chat' && <div className="flex items-center justify-center h-full text-gray-400">Chat em breve...</div>}
                    {activeTab === 'groups' && <div className="flex items-center justify-center h-full text-gray-400">Grupos em breve...</div>}
                </main>
            </div>
        </div>
    );
};

// Objeto que centraliza todas as chamadas para o backend.
         // --- CONEX√ÉO COM O BACKEND (GOOGLE APPS SCRIPT) ---
// URL do seu script publicado como aplicativo web.

// --- CONEX√ÉO COM O BACKEND (ATUALIZADO PARA GOOGLE.SCRIPT.RUN) ---

// --- CONEX√ÉO COM O BACKEND (GOOGLE APPS SCRIPT) ---
const api = {
    /**
     * Fun√ß√£o gen√©rica e interna para fazer uma chamada ao Google Apps Script.
     */
    _callApi: function(action, payload = {}) {
        return new Promise((resolve, reject) => {
            if (!window.google || !window.google.script) {
                console.error("Ambiente Google Apps Script n√£o detectado.");
                reject(new Error("Ambiente inv√°lido."));
                return;
            }
            google.script.run
                .withSuccessHandler((response) => {
                    if (response && response.status === 'error') {
                        console.error('Erro API:', response.message);
                        reject(new Error(response.message));
                    } else {
                        resolve(response ? response.data : null);
                    }
                })
                .withFailureHandler((error) => {
                    console.error("Falha cr√≠tica no Script:", error);
                    reject(error);
                })
                .handleApiRequest({ action: action, payload: payload });
        });
    },

    // --- M√âTODOS DE AUTENTICA√á√ÉO & ACESSO ---
    login: function(login, password) {
        return this._callApi('login', { login, password });
    },
    
    enviarSolicitacaoSenha: function(dados) {
        return this._callApi('enviarSolicitacaoSenha', dados);
    },

    solicitarNovoCadastro: function(dados) {
        return this._callApi('solicitarNovoCadastro', dados);
    },

    // --- M√âTODOS DE DADOS GERAIS ---
    getInitialData: function() {
        return this._callApi('getInitialData');
    },

    getDepartamentos: function() {
        return this._callApi('getDepartamentos');
    },

    getEventos: function() {
        return this._callApi('getEventos');
    },

    // --- M√âTODOS DE ESCALAS ---
    addEvent: function(eventData) {
        return this._callApi('addEvent', eventData);
    },
    
    getTodasAsEscalas: function() {
        return this._callApi('getTodasAsEscalas');
    },

    // --- M√âTODOS DO MURAL ---
    getMuralPosts: function() {
        return this._callApi('getMuralPosts');
    },

    publishMuralPost: function(postData) {
        return this._callApi('publishMuralPost', postData);
    },

    // --- M√âTODOS DO CALEND√ÅRIO (NOVOS) ---
    addCalendarEvent: function(eventData) {
        return this._callApi('addCalendarEvent', eventData);
    },

    updateCalendarEvent: function(eventData) {
        return this._callApi('updateCalendarEvent', eventData);
    },

    deleteCalendarEvent: function(id) {
        return this._callApi('deleteCalendarEvent', { id: id });
    }
};


        // --- Componente da Logo (recriada em SVG a partir da imagem do usu√°rio) ---
        const UserAppLogo = ({ className }) => (
            <svg viewBox="0 0 180 180" className={className} xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <clipPath id="rounded-corners">
                        <rect width="180" height="180" rx="35" ry="35" />
                    </clipPath>
                </defs>
                <g clipPath="url(#rounded-corners)">
                    <rect width="180" height="180" fill="#6d28d9" />
                    
                    {/* Calend√°rio */}
                    <path d="M45,40 a10,10 0 0,1 10,-10 h70 a10,10 0 0,1 10,10 v70 a10,10 0 0,1 -10,10 h-70 a10,10 0 0,1 -10,-10 Z" fill="white"/>
                    <rect x="45" y="55" width="90" height="8" fill="#6d28d9"/>
                    <rect x="62" y="22" width="12" height="20" rx="5" fill="white"/>
                    <rect x="106" y="22" width="12" height="20" rx="5" fill="white"/>
                    
                    {/* Checkmark */}
                    <path d="M60 95 l20 20 l45 -45" stroke="#6d28d9" strokeWidth="12" fill="none" strokeLinecap="round" strokeLinejoin="round" />

                    {/* Texto */}
                    <text x="90" y="155" fontFamily="Arial, sans-serif" fontSize="24" fill="white" textAnchor="middle" fontWeight="bold">Agendei7</text>
                </g>
            </svg>
        );


        // --- Mock Data (Dados Est√°ticos) ---
        const MOCK_USERS_DATA = {
            'admin': { id: 'admin', name: 'Admin', email: 'admin@agendei7.com', senha: 'admin', avatar: 'https://placehold.co/100x100/ef4444/ffffff?text=AD' },
            'u1': { id: 'u1', name: 'Ana Beatriz', email: 'ana@agendei7.com', senha: '123', avatar: 'https://placehold.co/100x100/6366f1/ffffff?text=AB' },
            'u2': { id: 'u2', name: 'Carlos Daniel', email: 'carlos@agendei7.com', senha: '456', avatar: 'https://placehold.co/100x100/ec4899/ffffff?text=CD' },
            'u3': { id: 'u3', name: 'Fernanda Lima', email: 'fernanda@agendei7.com', senha: '789', avatar: 'https://placehold.co/100x100/f59e0b/ffffff?text=FL' },
            'u4': { id: 'u4', name: 'Ricardo Neves', email: 'ricardo@agendei7.com', senha: 'abc', avatar: 'https://placehold.co/100x100/10b981/ffffff?text=RN' },
            'u5': { id: 'u5', name: 'Juliana Paes', email: 'juliana@agendei7.com', senha: 'def', avatar: 'https://placehold.co/100x100/3b82f6/ffffff?text=JP' },
        };
        
        const MOCK_EVENTS_DATA = [
            { id: 'evt1', name: 'Culto de Celebra√ß√£o', date: '2025-10-26', time: '10:00', location: 'Sal√£o Principal', description: 'Celebra√ß√£o dominical com louvor, palavra e comunh√£o.', status: 'Aberta', eventType: 'Culto', serviceType: 'Celebra√ß√£o', department: 'MINISTERIO DA MUSICA', responsible: 'S√©rgio',
                musicDetails: {
                    nomeCantor: 'Ana Beatriz',
                    integrante1: 'Carlos Daniel', integrante2: 'Fernanda Lima', integrante3: 'Ricardo Neves', integrante4: '',
                    musica1: 'Grande √© o Senhor', musica2: 'A Ele a Gl√≥ria', musica3: '', musica4: ''
                },
                logInfo: { RE_DATA_UPDATE: '15/10/2025 10:00', RE_DATA_MODIFICACAO: '15/10/2025 10:00', RE_USUARIO_LOGADO: 'Admin' }
            },
            { id: 'evt2', name: 'Ensaio do Minist√©rio de Louvor', date: '2025-10-31', time: '20:00', location: 'Sala de M√∫sica', description: 'Ensaio semanal para prepara√ß√£o dos c√¢nticos.', status: 'Fechada', eventType: 'Ensaio', serviceType: 'N/A', department: 'MINISTERIO DA MUSICA', responsible: 'S√©rgio', logInfo: { RE_DATA_UPDATE: '15/10/2025 10:05', RE_DATA_MODIFICACAO: '15/10/2025 10:05', RE_USUARIO_LOGADO: 'Admin' } },
            { id: 'evt3', name: 'A√ß√£o Social Comunit√°ria', date: '2025-11-08', time: '09:00', location: 'P√°tio da Igreja', description: 'Distribui√ß√£o de cestas b√°sicas e roupas para a comunidade local.', status: 'Aberta', eventType: 'A√ß√£o Social', serviceType: 'N/A', department: 'Social', responsible: 'Jocemara', logInfo: { RE_DATA_UPDATE: '16/10/2025 14:20', RE_DATA_MODIFICACAO: '16/10/2025 14:20', RE_USUARIO_LOGADO: 'Admin' } },
            { id: 'evt4', name: 'Vig√≠lia de Ora√ß√£o', date: '2025-11-14', time: '22:00', location: 'Sal√£o Principal', description: 'Uma noite dedicada √† ora√ß√£o e busca pela presen√ßa de Deus.', status: 'Em Andamento', eventType: 'Culto', serviceType: 'Vig√≠lia', department: 'Intercess√£o', responsible: 'Sebastian', logInfo: { RE_DATA_UPDATE: '17/10/2025 08:00', RE_DATA_MODIFICACAO: '17/10/2025 08:00', RE_USUARIO_LOGADO: 'Admin' } },
            { id: 'evt5', name: 'Reuni√£o de Planejamento', date: '2025-10-26', time: '19:00', location: 'Sala 2', description: 'Planejamento das atividades do pr√≥ximo m√™s.', status: 'Planejada', eventType: 'Reuni√£o', serviceType: 'N/A', department: 'SECRETARIA', responsible: 'Admin', logInfo: { RE_DATA_UPDATE: '17/10/2025 08:15', RE_DATA_MODIFICACAO: '17/10/2025 08:15', RE_USUARIO_LOGADO: 'Admin' } }
        ];

        const MOCK_SCALES_DATA = [
            { id: 's1', eventId: 'evt1', name: 'Vocal Principal', slots: 2 }, { id: 's2', eventId: 'evt1', name: 'Mesa de Som', slots: 1 },
            { id: 's3', eventId: 'evt1', name: 'Recep√ß√£o e Diaconia', slots: 4 }, { id: 's4', eventId: 'evt1', name: 'Proje√ß√£o (Datashow)', slots: 1 },
            { id: 's5', eventId: 'evt2', name: 'Viol√£o', slots: 1 }, { id: 's6', eventId: 'evt2', name: 'Vocal de Apoio', slots: 3 },
            { id: 's7', eventId: 'evt3', name: 'Montagem das Tendas', slots: 5 }, { id: 's8', eventId: 'evt3', name: 'Distribui√ß√£o de Alimentos', slots: 8 },
            { id: 's9', eventId: 'evt3', name: 'Aconselhamento', slots: 3 }, { id: 's10', eventId: 'evt4', name: 'Leitura B√≠blica', slots: 2 },
            { id: 's11', eventId: 'evt4', name: 'Condu√ß√£o do Louvor', slots: 1 },
        ];

        const MOCK_ASSIGNMENTS = {
            's1': ['u1', 'u2'], 's2': ['u4'], 's3': ['u3'], 's6': ['u5'], 's8': ['u1', 'u3', 'u4'],
        };
        
        const ALL_DEPARTMENTS_NAMES = ['DIACONATO', 'MINISTERIO DA MUSICA', 'MINISTERIO INFANTIL', 'SECRETARIA', 'Social', 'Intercess√£o', 'M√≠dia'];

        const MOCK_DEPARTMENTS_DATA = {
            'dept1': { DE_ID_DEPTO: 'dept1', DE_NOME_DEPARTAMENTO: 'DIACONATO', DE_LIDER_DEPTO: 'Jo√£o Silva', DE_ASSOCIADO_DEPTO: 'Maria Souza', DE_CONTATO: '11912345678', DE_ANCIAO_LIDER: 'Carlos Pereira', DE_EMAIL: 'diaconato@agendei7.com', logInfo: { RE_DATA_UPDATE: '10/10/2025 09:00', RE_DATA_MODIFICACAO: '10/10/2025 09:00', RE_USUARIO_LOGADO: 'Admin' } },
            'dept2': { DE_ID_DEPTO: 'dept2', DE_NOME_DEPARTAMENTO: 'MINISTERIO DA MUSICA', DE_LIDER_DEPTO: 'S√©rgio Santos', DE_ASSOCIADO_DEPTO: 'Ana Beatriz', DE_CONTATO: '11923456789', DE_ANCIAO_LIDER: 'Roberto Lima', DE_EMAIL: 'musica@agendei7.com', logInfo: { RE_DATA_UPDATE: '10/10/2025 09:05', RE_DATA_MODIFICACAO: '10/10/2025 09:05', RE_USUARIO_LOGADO: 'Admin' } },
            'dept3': { DE_ID_DEPTO: 'dept3', DE_NOME_DEPARTAMENTO: 'MINISTERIO INFANTIL', DE_LIDER_DEPTO: 'Fernanda Lima', DE_ASSOCIADO_DEPTO: 'Juliana Paes', DE_CONTATO: '11934567890', DE_ANCIAO_LIDER: 'Carlos Pereira', DE_EMAIL: 'infantil@agendei7.com', logInfo: { RE_DATA_UPDATE: '11/10/2025 11:30', RE_DATA_MODIFICACAO: '11/10/2025 11:30', RE_USUARIO_LOGADO: 'Admin' } },
        };
        
        const MOCK_ACCESS_DATA = {
            'acc1': { AC_ID: 'acc1', AC_LOGIN: 'ana.beatriz', AC_SENHA: '***', AC_DEPARTAMENTO: 'MINISTERIO DA MUSICA', AC_RESP: 'Ana Beatriz', AC_EMAIL: 'ana@agendei7.com', AC_APROVACAO: 'A', AC_NOTIFICACAO: 'Acesso total ao m√≥dulo de m√∫sica.', logInfo: { RE_DATA_UPDATE: '12/10/2025 15:00', RE_DATA_MODIFICACAO: '12/10/2025 15:00', RE_USUARIO_LOGADO: 'Admin' } },
            'acc2': { AC_ID: 'acc2', AC_LOGIN: 'carlos.daniel', AC_SENHA: '***', AC_DEPARTAMENTO: 'MINISTERIO DA MUSICA', AC_RESP: 'Carlos Daniel', AC_EMAIL: 'carlos@agendei7.com', AC_APROVACAO: 'P', AC_NOTIFICACAO: 'Aguardando aprova√ß√£o do l√≠der.', logInfo: { RE_DATA_UPDATE: '13/10/2025 10:00', RE_DATA_MODIFICACAO: '13/10/2025 10:00', RE_USUARIO_LOGADO: 'Admin' } },
            'acc3': { AC_ID: 'acc3', AC_LOGIN: 'jocemara.s', AC_SENHA: '***', AC_DEPARTAMENTO: 'Social', AC_RESP: 'Jocemara', AC_EMAIL: 'social@agendei7.com', AC_APROVACAO: 'I', AC_NOTIFICACAO: 'Usu√°rio inativo desde 01/10/2025.', logInfo: { RE_DATA_UPDATE: '01/09/2025 18:00', RE_DATA_MODIFICACAO: '01/10/2025 12:00', RE_USUARIO_LOGADO: 'Admin' } }
        };


        // --- Componentes da UI ---
const Header = ({ title, onBack, rightAction }) => (
    <header className="bg-white dark:bg-gray-800 shadow-md dark:shadow-gray-700 sticky top-0 z-20">
        <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex items-center justify-between h-16">
                {/* Lado Esquerdo (Voltar) */}
                <div className="w-1/4 flex justify-start">
                    {onBack ? (
                        <button onClick={onBack} className="text-violet-600 hover:text-violet-800 dark:text-violet-400 dark:hover:text-violet-300 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                    ) : <div className="w-6"></div>}
                </div>

                {/* Centro (T√≠tulo) */}
                <div className="w-2/4 flex justify-center">
                    <h1 className="text-xl font-bold text-gray-800 dark:text-gray-200 truncate">{title}</h1>
                </div>

                {/* Lado Direito (A√ß√£o/Salvar) */}
                <div className="w-1/4 flex justify-end">
                    {rightAction ? rightAction : <div className="w-6"></div>}
                </div>
            </div>
        </div>
    </header>
);
        
        const ConfirmationModal = ({ modalInfo, onConfirm, onCancel }) => {
            if (!modalInfo.isOpen) return null;
            
            const { title, message, confirmText, confirmColor } = modalInfo;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 transition-opacity duration-300">
                    <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-sm animate-fade-in-scale">
                        <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">{title}</h3>
                        <p className="text-gray-600 dark:text-gray-400 mb-6">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg text-sm hover:bg-gray-300 dark:hover:bg-gray-500 transition">
                                Cancelar
                            </button>
                            <button onClick={onConfirm} className={`text-white font-semibold py-2 px-4 rounded-lg text-sm transition ${confirmColor}`}>
                                {confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const NotificationChoiceModal = ({ isOpen, departmentName, onSendEmail, onSendWhatsApp, onClose }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-sm text-center animate-fade-in-scale">
                        <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">Notificar Departamento</h3>
                        <p className="text-gray-600 dark:text-gray-400 mb-6">Como deseja notificar o departamento <span className="font-semibold">{departmentName}</span>?</p>
                        <div className="flex flex-col gap-3">
                            <button onClick={onSendWhatsApp} className="w-full flex items-center justify-center gap-2 bg-green-500 text-white font-semibold py-3 px-4 rounded-lg text-sm hover:bg-green-600 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                                WhatsApp
                            </button>
                            <button onClick={onSendEmail} className="w-full flex items-center justify-center gap-2 bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg text-sm hover:bg-blue-600 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg>
                                E-mail
                            </button>
                            <button onClick={onClose} className="w-full bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg text-sm hover:bg-gray-300 dark:hover:bg-gray-500 transition">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const LoadingModal = ({ isOpen, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 w-full max-w-sm text-center flex flex-col items-center">
                        <div className="loader mb-4"></div>
                        <p className="text-gray-700 dark:text-gray-300 font-semibold">{message}</p>
                    </div>
                </div>
            );
        };
        
        const InfoToast = ({ isVisible, message }) => {
            if (!isVisible) return null;
            return (
                <div className="fixed bottom-20 left-1/2 -translate-x-1/2 bg-green-500 text-white py-2 px-6 rounded-full shadow-lg z-50 animate-fade-in-out">
                    {message}
                </div>
            );
        };

        const SuccessModal = ({ isOpen, title, message, onAddNew, onGoToDashboard }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-sm text-center animate-fade-in-scale">
                        <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 dark:bg-green-900 mb-4">
                            <svg className="h-6 w-6 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">{title}</h3>
                        <p className="text-gray-600 dark:text-gray-400 mb-6">{message}</p>
                        <div className="flex flex-col gap-3">
                            <button onClick={onAddNew} className="w-full bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:bg-violet-700 transition">
                                Inserir Novo Agendamento
                            </button>
                            <button onClick={onGoToDashboard} className="w-full bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg text-sm hover:bg-gray-300 dark:hover:bg-gray-500 transition">
                                Retornar para tela inicial
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const UpdateResultModal = ({ status, onRetry, onGoBack, logMessage }) => {
            if (status === 'idle' || status === 'loading') return null;

            const isSuccess = status === 'success';
            
            return (
                 <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md text-center animate-fade-in-scale">
                        <div className={`mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 ${isSuccess ? 'bg-green-100 dark:bg-green-900' : 'bg-red-100 dark:bg-red-900'}`}>
                            {isSuccess ? (
                                <svg className="h-6 w-6 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />
                                </svg>
                            ) : (
                                <svg className="h-6 w-6 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            )}
                        </div>
                        <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">{isSuccess ? "Atualiza√ß√£o Conclu√≠da!" : "Falha na Atualiza√ß√£o"}</h3>
                        <p className="text-gray-600 dark:text-gray-400 mb-6">{isSuccess ? "Os dados da tabela foram atualizados com sucesso." : "Ocorreu um erro ao tentar atualizar os dados."}</p>
                        
                        {!isSuccess && logMessage && (
                            <div className="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 text-left text-xs text-gray-700 dark:text-gray-300 font-mono mb-6 overflow-x-auto">
                                <p className="font-semibold mb-1">Log do Erro:</p>
                                <pre>{logMessage}</pre>
                            </div>
                        )}

                        <div className="flex flex-col gap-3">
                           {isSuccess ? (
                                <>
                                    <button onClick={onRetry} className="w-full bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:bg-violet-700 transition">
                                        Realizar Novo Update
                                    </button>
                                     <button onClick={onGoBack} className="w-full bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg text-sm hover:bg-gray-300 dark:hover:bg-gray-500 transition">
                                        Voltar para Configura√ß√µes
                                    </button>
                                </>
                           ) : (
                                <>
                                    <button onClick={onRetry} className="w-full bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:bg-violet-700 transition">
                                        Tentar Novamente
                                    </button>
                                     <button onClick={onGoBack} className="w-full bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg text-sm hover:bg-gray-300 dark:hover:bg-gray-500 transition">
                                        Voltar
                                    </button>
                                </>
                           )}
                        </div>
                    </div>
                </div>
            )
        };


        const BottomNav = ({ activeView, setView }) => {
            const navItems = [
                { id: 'dashboard', icon: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />, label: 'In√≠cio' },
                { id: 'calendar', icon: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />, label: 'Calend√°rio' },
                { id: 'profile', icon: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />, label: 'Perfil' },
            ];
            
            return (
                <div className="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-t border-t border-gray-200 dark:border-gray-700 max-w-4xl mx-auto">
                    <div className="flex justify-around h-16">
                        {navItems.map(item => (
                            <button key={item.id} onClick={() => setView(item.id)} className={`flex flex-col items-center justify-center w-full transition ${activeView === item.id ? 'text-violet-600 dark:text-violet-400' : 'text-gray-500 dark:text-gray-400 hover:text-violet-600 dark:hover:text-violet-400'}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">{item.icon}</svg>
                                <span className="text-xs mt-1">{item.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const EventCard = ({ event, onClick, onEdit }) => {
            const getEventDateData = (dateRaw) => {
                try {
                    let dateObj;
                    if (!dateRaw) return { day: '--', month: '---' };
                    if (typeof dateRaw === 'string' && dateRaw.includes('-')) {
                        const parts = dateRaw.split('T')[0].split('-');
                        dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
                    } else { dateObj = new Date(dateRaw); }
                    if (isNaN(dateObj.getTime())) return { day: '??', month: '???' };
                    const day = dateObj.getDate();
                    const month = dateObj.toLocaleString('pt-BR', { month: 'short' }).replace('.', '').toUpperCase();
                    return { day, month };
                } catch (e) { return { day: 'ER', month: 'RO' }; }
            };

            const { day, month } = getEventDateData(event.date);
            const isConfirmed = event.status === 'Evento Confirmado';
            const statusClass = isConfirmed ? "bg-green-100 text-green-700 border-green-200" : "bg-red-100 text-red-700 border-red-200";

            return (
                <div onClick={onClick} className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 flex flex-col gap-3 cursor-pointer hover:shadow-lg transition border-l-4 border-violet-500 relative group">
                    
                    {/* BOT√ÉO DE EDI√á√ÉO (CORRIGIDO) */}
                    {onEdit && (
                        <button 
                            // AQUI ESTAVA O ERRO: Deve chamar 'onEdit', n√£o 'onEditEvent'
                            onClick={(e) => { e.stopPropagation(); onEdit(event); }}
                            className="absolute top-2 right-2 p-2 bg-gray-100 hover:bg-violet-100 text-gray-500 hover:text-violet-600 rounded-full transition z-10"
                            title="Editar Evento"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z" /></svg>
                        </button>
                    )}

                    <div className="flex items-start justify-between pr-8">
                        <div className="flex items-center gap-4">
                            <div className="flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-700 rounded-lg w-14 h-14 text-gray-600 dark:text-gray-300 shrink-0 font-bold border">
                                <span className="text-[10px] uppercase">{month}</span>
                                <span className="text-xl">{day}</span>
                            </div>
                            <div>
                                <h3 className="font-bold text-gray-800 dark:text-gray-200 text-lg leading-tight">{event.name}</h3>
                                <p className="text-sm text-gray-500 dark:text-gray-400 font-medium">{event.branch}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex justify-between items-center mt-1">
                         <span className={`text-[10px] font-bold px-2 py-1 rounded-full border ${statusClass}`}>
                            {isConfirmed ? 'CONFIRMADO' : 'CANCELADO'}
                        </span>
                    </div>
                    
                    <div className="flex items-center gap-4 text-xs text-gray-500 dark:text-gray-400 border-t pt-2 dark:border-gray-700">
                        <div className="flex items-center gap-1">
                            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <span>{event.time || '--:--'}</span>
                        </div>
                         <div className="flex items-center gap-1 truncate flex-1">
                            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" /></svg>
                            <span className="truncate">{event.description || 'Sem observa√ß√µes'}</span>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Telas (Views) ---

const LoginPage = ({ onLogin, initialDepartments = [] }) => {
            // Estados de Navega√ß√£o
            const [mode, setMode] = useState('login'); // 'login', 'forgot', 'register'
            const [isLoading, setIsLoading] = useState(false);
            
            // --- CORRE√á√ÉO AQUI: Declara√ß√£o √∫nica usando a prop inicial ---
            const [departments, setDepartments] = useState(initialDepartments);
            
            const [feedbackMsg, setFeedbackMsg] = useState({ type: '', text: '' });

            // Campos de Login
            const [loginData, setLoginData] = useState({ login: '', password: '' });
            const [showPassword, setShowPassword] = useState(false);

            // Campos de Recupera√ß√£o e Cadastro (Compartilhados)
            const [formData, setFormData] = useState({
                departamento: '', responsavel: '', email: '', telefone: '',
                login: '', senha: '', confirmSenha: '', infos: ''
            });

            // Efeito: Carrega departamentos apenas se a lista inicial estiver vazia
            useEffect(() => {
                if (departments.length === 0) {
                    api.getDepartamentos().then(data => {
                        if (Array.isArray(data)) setDepartments(data);
                    }).catch(console.error);
                }
            }, []);

            const handleInputChange = (e, stateUpdater) => {
                const { name, value } = e.target;
                stateUpdater(prev => ({ ...prev, [name]: value }));
            };

            // --- A√á√ÉO 1: FAZER LOGIN ---
            const handleLoginSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setFeedbackMsg({ type: '', text: '' });
                try {
                    const result = await api.login(loginData.login, loginData.password);
                    if (result && result.acesso === true) {
                        const userData = {
                            id: loginData.login,
                            name: result.perfil || loginData.login,
                            email: result.email || '',
                            avatar: 'https://placehold.co/100x100/6d28d9/ffffff?text=' + loginData.login.substring(0,2).toUpperCase(),
                            role: 'Membro'
                        };
                        onLogin(userData);
                    } else {
                        setFeedbackMsg({ type: 'error', text: result.motivo === 'STATUS_INVALIDO' ? 'Acesso pendente de aprova√ß√£o.' : 'Login ou senha inv√°lidos.' });
                    }
                } catch (err) {
                    setFeedbackMsg({ type: 'error', text: 'Erro de conex√£o.' });
                } finally { setIsLoading(false); }
            };

            // --- A√á√ÉO 2: RECUPERAR SENHA ---
            const handleForgotSubmit = async (e) => {
                e.preventDefault();
                if (formData.senha !== formData.confirmSenha) return setFeedbackMsg({ type: 'error', text: 'As senhas n√£o coincidem.' });
                
                setIsLoading(true);
                try {
                    await api.enviarSolicitacaoSenha({
                        departamento: formData.departamento,
                        responsavel: formData.responsavel,
                        email: formData.email,
                        telefone: formData.telefone,
                        novaSenha: formData.senha
                    });
                    alert("Solicita√ß√£o enviada ao Administrador!");
                    setMode('login');
                    setFeedbackMsg({ type: 'success', text: 'Solicita√ß√£o enviada com sucesso.' });
                } catch (err) {
                    setFeedbackMsg({ type: 'error', text: 'Erro ao enviar solicita√ß√£o.' });
                } finally { setIsLoading(false); }
            };

            // --- A√á√ÉO 3: NOVO CADASTRO ---
            const handleRegisterSubmit = async (e) => {
                e.preventDefault();
                if (formData.senha !== formData.confirmSenha) return setFeedbackMsg({ type: 'error', text: 'As senhas n√£o coincidem.' });

                setIsLoading(true);
                try {
                    await api.solicitarNovoCadastro({
                        departamento: formData.departamento,
                        login: formData.login,
                        senha: formData.senha,
                        nome: formData.responsavel,
                        email: formData.email,
                        telefone: formData.telefone,
                        infos: formData.infos
                    });
                    alert("Cadastro solicitado! Aguarde aprova√ß√£o.");
                    setMode('login');
                    setFeedbackMsg({ type: 'success', text: 'Cadastro solicitado com sucesso.' });
                } catch (err) {
                    setFeedbackMsg({ type: 'error', text: 'Erro ao solicitar cadastro.' });
                } finally { setIsLoading(false); }
            };

            return (
                <div className="min-h-screen bg-violet-700 flex flex-col justify-center items-center p-4 animate-fade-in">
                    <UserAppLogo className="w-32 h-32 mb-4" />
                    <div className="w-full max-w-md bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl">
                        
                        <h2 className="text-2xl font-bold text-center text-gray-800 dark:text-gray-200 mb-6">
                            {mode === 'login' ? 'Bem-vindo' : mode === 'forgot' ? 'Recuperar Senha' : 'Solicitar Cadastro'}
                        </h2>

                        {feedbackMsg.text && (
                            <div className={`mb-4 p-3 rounded text-sm text-center ${feedbackMsg.type === 'error' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                                {feedbackMsg.text}
                            </div>
                        )}

                        {mode === 'login' && (
                            <form onSubmit={handleLoginSubmit}>
                                <div className="mb-4">
                                    <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Login</label>
                                    <input type="text" name="login" value={loginData.login} onChange={e => handleInputChange(e, setLoginData)} className="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Digite seu login" required />
                                </div>
                                <div className="mb-2">
                                    <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Senha</label>
                                    <div className="relative">
                                        <input type={showPassword ? "text" : "password"} name="password" value={loginData.password} onChange={e => handleInputChange(e, setLoginData)} className="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Digite sua senha" required />
                                        <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-3 flex items-center text-gray-500">
                                            {showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="flex justify-end mb-6">
                                    <button type="button" onClick={() => { setFeedbackMsg({}); setMode('forgot'); }} className="text-sm text-violet-600 hover:underline font-semibold">
                                        Esqueceu a senha?
                                    </button>
                                </div>

                                <button type="submit" disabled={isLoading} className="w-full bg-violet-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-violet-700 transition shadow-lg flex justify-center">
                                    {isLoading ? <span className="loader w-5 h-5 border-2 border-white border-t-transparent"></span> : 'Entrar'}
                                </button>

                                <div className="my-6 border-t border-gray-200 dark:border-gray-700 relative">
                                    <span className="absolute top-[-10px] left-1/2 transform -translate-x-1/2 bg-white dark:bg-gray-800 px-2 text-xs text-gray-500">OU</span>
                                </div>

                                <button type="button" onClick={() => { setFeedbackMsg({}); setMode('register'); }} className="w-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-bold py-3 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition border border-gray-300 dark:border-gray-600">
                                    Solicitar Acesso
                                </button>
                            </form>
                        )}

                        {(mode === 'forgot' || mode === 'register') && (
                            <form onSubmit={mode === 'forgot' ? handleForgotSubmit : handleRegisterSubmit} className="space-y-3">
                                <div>
                                    <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">Departamento</label>
                                    <select name="departamento" value={formData.departamento} onChange={e => handleInputChange(e, setFormData)} className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white" required>
                                        <option value="">Selecione...</option>
                                        {departments.map(d => <option key={d} value={d}>{d}</option>)}
                                        <option value="Outro">Outro / Novo</option>
                                    </select>
                                </div>
                                
                                {mode === 'register' && (
                                    <div>
                                        <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">Login Desejado</label>
                                        <input type="text" name="login" value={formData.login} onChange={e => handleInputChange(e, setFormData)} className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white" required />
                                    </div>
                                )}

                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">Nome Respons√°vel</label>
                                        <input type="text" name="responsavel" value={formData.responsavel} onChange={e => handleInputChange(e, setFormData)} className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white" required />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">Telefone</label>
                                        <input type="tel" name="telefone" value={formData.telefone} onChange={e => handleInputChange(e, setFormData)} className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white" required />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">E-mail</label>
                                    <input type="email" name="email" value={formData.email} onChange={e => handleInputChange(e, setFormData)} className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white" required />
                                </div>

                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">{mode === 'forgot' ? 'Nova Senha' : 'Senha'}</label>
                                        <input type="password" name="senha" value={formData.senha} onChange={e => handleInputChange(e, setFormData)} className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white" required />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">Confirmar Senha</label>
                                        <input type="password" name="confirmSenha" value={formData.confirmSenha} onChange={e => handleInputChange(e, setFormData)} className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white" required />
                                    </div>
                                </div>

                                {mode === 'register' && (
                                    <div>
                                        <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">Informa√ß√µes Gerais</label>
                                        <textarea name="infos" value={formData.infos} onChange={e => handleInputChange(e, setFormData)} className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white h-16 text-sm" placeholder="Ex: Sou novo l√≠der do minist√©rio..."></textarea>
                                    </div>
                                )}

                                <button type="submit" disabled={isLoading} className="w-full bg-violet-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-violet-700 transition shadow-lg mt-4 flex justify-center">
                                    {isLoading ? <span className="loader w-5 h-5 border-2 border-white border-t-transparent"></span> : (mode === 'forgot' ? 'Solicitar Altera√ß√£o' : 'Enviar Cadastro')}
                                </button>

                                <button type="button" onClick={() => setMode('login')} className="w-full text-gray-500 hover:text-gray-700 text-sm font-bold py-2 mt-2">
                                    Cancelar e Voltar
                                </button>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        // --- Componente DashboardPage Completo ---
// --- 1. DASHBOARD (Com bot√£o do sino e bot√£o de adicionar evento) ---
        const DashboardPage = ({ currentUser, setView, setEventId, mockEvents, onOpenNotifications }) => {
            // Garante que mockEvents seja sempre um array
            const eventosParaExibir = Array.isArray(mockEvents) ? mockEvents : [];

            return (
                <div>
                    <header className="bg-white dark:bg-gray-800 shadow-md dark:shadow-gray-700 sticky top-0 z-10">
                        <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex items-center justify-between h-16">
                                <div className="w-6"></div> 
                                <h1 className="text-xl font-bold text-gray-800 dark:text-gray-200">In√≠cio</h1>
                                
                                {/* BOT√ÉO DO SINO (NOTIFICA√á√ïES) */}
                                <button 
                                    onClick={onOpenNotifications} 
                                    className="p-2 rounded-full text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 transition relative"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                    </svg>
                                    {/* Bolinha vermelha */}
                                    <span className="absolute top-2 right-2 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white dark:ring-gray-800"></span>
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="p-4 pb-20 max-w-4xl mx-auto">
                        <div className="bg-white dark:bg-gray-800 rounded-lg p-4 mb-6 shadow">
                            <h2 className="text-xl font-bold text-gray-800 dark:text-gray-200">Ol√°, {currentUser.name ? currentUser.name.split(' ')[0].toUpperCase() : 'USU√ÅRIO'}!</h2>
                            <p className="text-gray-600 dark:text-gray-400">O que voc√™ gostaria de fazer hoje?</p>
                        </div>

                        {/* MENU DE GERENCIAMENTO (Apenas Admin/Master) */}
                        {(currentUser.id === 'admin' || currentUser.id === 'admin_master') && (
                            <div className="mb-6">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-gray-200 mb-3">Gerenciamento</h3>
                                <div className="grid grid-cols-3 gap-2">
                                    <button onClick={() => setView('addEvent')} className="bg-violet-600 text-white rounded-lg p-2 shadow-lg hover:bg-violet-700 transition flex flex-col items-center justify-center text-center h-24">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        <span className="font-semibold text-xs">Incluir Agendamento</span>
                                    </button>
                                    <button onClick={() => setView('editScales')} className="bg-violet-600 text-white rounded-lg p-2 shadow-lg hover:bg-violet-700 transition flex flex-col items-center justify-center text-center h-24">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z" /></svg>
                                        <span className="font-semibold text-xs">Editar Escalas</span>
                                    </button>
                                    <button onClick={() => setView('generateRoteiro')} className="bg-violet-600 text-white rounded-lg p-2 shadow-lg hover:bg-violet-700 transition flex flex-col items-center justify-center text-center h-24">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                        <span className="font-semibold text-xs">Gerar Roteiro</span>
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* LISTA DE PR√ìXIMOS EVENTOS (CALEND√ÅRIO) */}
                        <div className="space-y-4">
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-gray-200">Pr√≥ximos Eventos (Calend√°rio)</h3>
                                
                                {/* BOT√ÉO ADICIONAR EVENTO (Roxo e Pequeno) */}
                                <button 
                                    onClick={() => setView('addCalendarEvent')}
                                    className="bg-violet-600 hover:bg-violet-700 text-white text-xs font-bold py-1.5 px-3 rounded-lg transition flex items-center gap-1 shadow-sm"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                                    Adicionar
                                </button>
                            </div>
                            
                            {eventosParaExibir.length === 0 ? (
                                <p className="text-gray-500 text-sm text-center py-4">Nenhum evento pr√≥ximo.</p>
                            ) : (
                                eventosParaExibir.map(event => (
                              <EventCard 
                                  key={event.id} 
                                  event={event} 
                                  onClick={() => { setEventId(event.id); setView('eventDetail'); }} 
                                  onEdit={(evt) => onEditEvent(evt)}
                              />
                          ))
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        // --- 2. NOVO COMPONENTE: ADICIONAR EVENTO AO CALEND√ÅRIO ---
// --- COMPONENTE ATUALIZADO: ADICIONAR EVENTO AO CALEND√ÅRIO ---
        const AddCalendarEventPage = ({ setView, onSaveSuccess, branches = [], editingEvent = null }) => {
            const [formData, setFormData] = useState({
                id: '',
                date: '',
                time: '',
                name: '',
                location: '',
                description: '',
                branch: '',
                status: 'Evento Confirmado'
            });
            const [attachment, setAttachment] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const fileInputRef = useRef(null);
            const isEditing = !!editingEvent;

            // Preenche dados se for edi√ß√£o
            useEffect(() => {
                if (isEditing && editingEvent) {
                    setFormData({
                        id: editingEvent.id,
                        name: editingEvent.name,
                        location: editingEvent.location,
                        description: editingEvent.description,
                        branch: editingEvent.branch || editingEvent.department, // Fallback
                        status: editingEvent.status,
                        date: editingEvent.date, // Assume YYYY-MM-DD do backend corrigido
                        time: editingEvent.time
                    });
                    // Nota: Anexos antigos n√£o s√£o mostrados no input file, mas mantidos no backend se n√£o trocados
                }
            }, [editingEvent]);

            const fileToBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.branch) return alert("Selecione uma Filial.");
                setIsSaving(true);
                try {
                    let payload = { ...formData };
                    if (attachment) {
                        const base64 = await fileToBase64(attachment);
                        payload.fileData = base64;
                        payload.fileName = attachment.name;
                        payload.mimeType = attachment.type;
                    }

                    // Se tem ID e √© edi√ß√£o, chama update. Sen√£o, add.
                    if (isEditing) {
                        await api.updateCalendarEvent(payload);
                        alert("Evento atualizado com sucesso!");
                    } else {
                        await api.addCalendarEvent(payload);
                        alert("Evento criado com sucesso!");
                    }
                    onSaveSuccess(); 
                } catch (error) {
                    alert("Erro: " + error.message);
                } finally {
                    setIsSaving(false);
                }
            };

            const handleDelete = async () => {
                if (!confirm("Tem certeza que deseja EXCLUIR este evento?")) return;
                setIsSaving(true);
                try {
                    await api.deleteCalendarEvent(formData.id);
                    alert("Evento exclu√≠do!");
                    onSaveSuccess();
                } catch (error) {
                    alert("Erro ao excluir: " + error.message);
                    setIsSaving(false);
                }
            };

            return (
                <div>
                    <Header title={isEditing ? "Editar Evento" : "Novo Evento"} onBack={() => setView('dashboard')} />
                    <main className="p-4 max-w-4xl mx-auto">
                        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <h2 className="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4">Detalhes do Evento</h2>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">T√≠tulo do Evento</label>
                                    <input type="text" required className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white" 
                                        value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Filial (Igreja) <span className="text-red-500">*</span></label>
                                        <select required className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white"
                                            value={formData.branch} onChange={e => setFormData({...formData, branch: e.target.value})}>
                                            <option value="">Selecione...</option>
                                            {branches.map((b, idx) => <option key={idx} value={b}>{b}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Status</label>
                                        <select required className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white"
                                            value={formData.status} onChange={e => setFormData({...formData, status: e.target.value})}>
                                            <option value="Evento Confirmado">Evento Confirmado</option>
                                            <option value="Evento Cancelado">Evento Cancelado</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Data</label>
                                        <input type="date" required className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white" 
                                            value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Hor√°rio</label>
                                        <input type="time" required className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white" 
                                            value={formData.time} onChange={e => setFormData({...formData, time: e.target.value})} />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Local</label>
                                    <input type="text" required className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white" 
                                        value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})} />
                                </div>

                                <div>
                                    <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Anexo (Banner)</label>
                                    <div className="flex items-center gap-2">
                                        <label className="cursor-pointer bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded border text-sm font-semibold">
                                            Escolher Arquivo
                                            <input type="file" ref={fileInputRef} className="hidden" onChange={e => setAttachment(e.target.files[0])} />
                                        </label>
                                        <span className="text-xs text-gray-500 truncate max-w-xs">
                                            {attachment ? attachment.name : isEditing && editingEvent.attachment ? 'Anexo Existente (Envie outro para substituir)' : 'Nenhum arquivo'}
                                        </span>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Descri√ß√£o</label>
                                    <textarea className="w-full p-2 border rounded dark:bg-gray-700 dark:text-white h-24" 
                                        value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})}></textarea>
                                </div>

                                <button type="submit" disabled={isSaving} className="w-full bg-violet-600 text-white font-bold py-3 rounded-lg hover:bg-violet-700 transition flex justify-center items-center">
                                    {isSaving ? <div className="loader w-5 h-5 border-2 border-white border-t-transparent"></div> : (isEditing ? 'Atualizar Dados' : 'Salvar Evento')}
                                </button>

                                {isEditing && (
                                    <button type="button" onClick={handleDelete} disabled={isSaving} className="w-full bg-red-100 text-red-600 font-bold py-3 rounded-lg hover:bg-red-200 transition mt-2">
                                        Excluir Evento
                                    </button>
                                )}
                            </form>
                        </div>
                    </main>
                </div>
            );
        };

        // --- 3. COMPONENTE EXISTENTE: ADICIONAR AGENDAMENTO (ESCALA) ---
        const AddEventPage = ({ setView, setMockEvents, mockEvents, editingEventId, setEditingEventId }) => {
            const [date, setDate] = useState('');
            const [status, setStatus] = useState('Aberta');
            const [department, setDepartment] = useState('');
            const [eventType, setEventType] = useState('');
            const [responsible, setResponsible] = useState('');
            const [mainRole, setMainRole] = useState('');
            const [observations, setObservations] = useState('');
            const [attachment, setAttachment] = useState(null);
            const [showSuccess, setShowSuccess] = useState(false);
            
            const [nomeCantor, setNomeCantor] = useState('');
            const [integrante1, setIntegrante1] = useState('');
            const [integrante2, setIntegrante2] = useState('');
            const [integrante3, setIntegrante3] = useState('');
            const [integrante4, setIntegrante4] = useState('');
            const [musica1, setMusica1] = useState('');
            const [musica2, setMusica2] = useState('');
            const [musica3, setMusica3] = useState('');
            const [musica4, setMusica4] = useState('');
            const [existingAttachmentName, setExistingAttachmentName] = useState('');

            const departmentOptions = ALL_DEPARTMENTS_NAMES;
            const eventTypeOptions = ['Culto', 'CULTO DE S√ÅBADO', 'Ensaio', 'A√ß√£o Social', 'Reuni√£o', 'Vig√≠lia'];
            const statusOptions = ['Aberta', 'Fechada', 'Em Andamento', 'Planejada'];
            const roleOptions = ['Louvor', 'Palavra', 'Recep√ß√£o', 'M√≠dia', 'Social'];

            const isEditing = !!editingEventId;

            useEffect(() => {
                if (!editingEventId) {
                    resetForm();
                    return;
                }

                const eventToEdit = mockEvents.find(e => e.id === editingEventId);
                if (eventToEdit) {
                    setDate(eventToEdit.date || '');
                    setStatus(eventToEdit.status || 'Aberta');
                    setDepartment(eventToEdit.department || '');
                    setEventType(eventToEdit.eventType || '');
                    setResponsible(eventToEdit.responsible || '');
                    setMainRole(eventToEdit.mainRole || '');
                    setObservations(eventToEdit.description || '');
                    setAttachment(null);
                    setExistingAttachmentName(eventToEdit.attachmentName || '');
                    
                    const fileInput = document.getElementById('attachment');
                    if(fileInput) fileInput.value = '';

                    if (eventToEdit.musicDetails) {
                        const {
                            nomeCantor = '', integrante1 = '', integrante2 = '', integrante3 = '', integrante4 = '',
                            musica1 = '', musica2 = '', musica3 = '', musica4 = ''
                        } = eventToEdit.musicDetails;
                        setNomeCantor(nomeCantor);
                        setIntegrante1(integrante1);
                        setIntegrante2(integrante2);
                        setIntegrante3(integrante3);
                        setIntegrante4(integrante4);
                        setMusica1(musica1);
                        setMusica2(musica2);
                        setMusica3(musica3);
                        setMusica4(musica4);
                    } else {
                        setNomeCantor(''); setIntegrante1(''); setIntegrante2('');
                        setIntegrante3(''); setIntegrante4(''); setMusica1('');
                        setMusica2(''); setMusica3(''); setMusica4('');
                    }
                }
            }, [editingEventId, mockEvents]);

            const resetForm = () => {
                setDate(''); setStatus('Aberta'); setDepartment('');
                setEventType(''); setResponsible(''); setMainRole('');
                setObservations(''); setAttachment(null);
                setExistingAttachmentName('');
                
                const fileInput = document.getElementById('attachment');
                if(fileInput) fileInput.value = '';

                setNomeCantor(''); setIntegrante1(''); setIntegrante2('');
                setIntegrante3(''); setIntegrante4(''); setMusica1('');
                setMusica2(''); setMusica3(''); setMusica4('');
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!date || !department || !eventType || !responsible) {
                    alert('Por favor, preencha todos os campos obrigat√≥rios.');
                    return;
                }
                
                const eventData = {
                    name: eventType, date,
                    description: observations, status, eventType, 
                    department, responsible, mainRole,
                    attachmentName: attachment ? attachment.name : existingAttachmentName,
                    musicDetails: department === 'MINISTERIO DA MUSICA' ? {
                        nomeCantor, integrante1, integrante2, integrante3, integrante4,
                        musica1, musica2, musica3, musica4
                    } : null
                };

                if (isEditing) {
                    // Para edi√ß√£o real, voc√™ precisaria criar um m√©todo api.updateEvent
                    alert('Edi√ß√£o realizada localmente (API de update pendente).');
                    setEditingEventId(null);
                    setView('editScales');
                } else {
                    api.addEvent(eventData).then(() => {
                        setShowSuccess(true);
                    });
                }
            };

            const isMusica = department === 'MINISTERIO DA MUSICA';
            const isCultoS√°bado = eventType === 'CULTO DE S√ÅBADO';
            const optionalFieldsRequired = isMusica && isCultoS√°bado;
            
            const handleBack = () => {
                setEditingEventId(null);
                setView(isEditing ? 'editScales' : 'dashboard');
            };

            return (
                <div>
                    <Header title={isEditing ? "Editar Agendamento" : "Incluir Novo Agendamento"} onBack={handleBack} />
                    <SuccessModal 
                        isOpen={showSuccess}
                        title="Agendamento Inclu√≠do!"
                        message={`O evento "${eventType}" foi criado com sucesso.`}
                        onAddNew={() => { setShowSuccess(false); resetForm(); }}
                        onGoToDashboard={() => { setShowSuccess(false); setView('dashboard'); }}
                    />
                    <main className="p-4 pb-20 max-w-4xl mx-auto">
                        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Data <span className="text-red-500">*</span></label>
                                        <input type="date" value={date} onChange={e => setDate(e.target.value)} className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 dark:border-gray-600" required />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Status da Escala <span className="text-red-500">*</span></label>
                                        <select value={status} onChange={e => setStatus(e.target.value)} className="border-gray-300 rounded-md shadow-sm w-full dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600" required>
                                            {statusOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Departamento <span className="text-red-500">*</span></label>
                                        <select value={department} onChange={e => setDepartment(e.target.value)} className="border-gray-300 rounded-md shadow-sm w-full dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600" required>
                                            <option value="" disabled>Selecione...</option>
                                            {departmentOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Tipo do Evento <span className="text-red-500">*</span></label>
                                        <select value={eventType} onChange={e => setEventType(e.target.value)} className="border-gray-300 rounded-md shadow-sm w-full dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600" required>
                                            <option value="" disabled>Selecione...</option>
                                            {eventTypeOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Nome do Respons√°vel <span className="text-red-500">*</span></label>
                                    <input type="text" value={responsible} onChange={e => setResponsible(e.target.value)} className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 dark:border-gray-600" required />
                                </div>
                                 <div>
                                    <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Fun√ß√£o Principal</label>
                                    <select value={mainRole} onChange={e => setMainRole(e.target.value)} className="border-gray-300 rounded-md shadow-sm w-full dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600">
                                        <option value="">Nenhuma</option>
                                        {roleOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                    </select>
                                </div>
                                
                                {isMusica && (
                                    <div className="space-y-4 border-t border-gray-200 dark:border-gray-700 pt-6 mt-6">
                                        <h3 className="text-lg font-semibold text-gray-800 dark:text-gray-200">Detalhes do Louvor</h3>
                                        <div>
                                            <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Nome do Cantor <span className="text-red-500">*</span></label>
                                            <input type="text" value={nomeCantor} onChange={e => setNomeCantor(e.target.value)} className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 dark:border-gray-600" required />
                                        </div>
                                        {/* ... (Campos de m√∫sica mantidos resumidos para caber no bloco, l√≥gica igual) ... */}
                                    </div>
                                )}

                                <div>
                                    <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Observa√ß√µes</label>
                                    <textarea value={observations} onChange={e => setObservations(e.target.value)} rows="3" className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 dark:border-gray-600"></textarea>
                                </div>
                                <div>
                                    <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Anexo</label>
                                    {isEditing && existingAttachmentName && (
                                        <div className="flex items-center justify-between bg-gray-100 dark:bg-gray-700 p-2 rounded-md mb-2 text-sm">
                                            <span className="text-gray-700 dark:text-gray-300 truncate mr-2">{existingAttachmentName}</span>
                                            <button type="button" onClick={() => setExistingAttachmentName('')} className="text-red-500 hover:text-red-700 font-semibold" title="Remover anexo">Remover</button>
                                        </div>
                                    )}
                                    <input id="attachment" type="file" onChange={e => { const file = e.target.files[0]; setAttachment(file); setExistingAttachmentName(file ? file.name : ''); }} className="text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 dark:file:bg-violet-900/50 file:text-violet-700 dark:file:text-violet-300 hover:file:bg-violet-100 dark:hover:file:bg-violet-900" />
                                </div>
                                <div className="pt-4">
                                    <button type="submit" className="w-full bg-violet-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-violet-700 transition duration-300 shadow-lg">
                                        {isEditing ? 'Salvar Altera√ß√µes' : 'Incluir Agendamento'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </main>
                </div>
            );
        };
        

        const EditScalesPage = ({ setView, mockEvents, setMockEvents, setEditingEventId }) => {
            const initialFilters = {
                date: '', status: 'Todos', eventType: 'Todos', serviceType: 'Todos', department: 'Todos'
            };

            const [filters, setFilters] = useState(initialFilters);
            const [modalInfo, setModalInfo] = useState({ isOpen: false, type: null, event: null });

            const filterOptions = useMemo(() => {
                const departments = [...new Set(mockEvents.map(e => e.department))];
                const statuses = [...new Set(mockEvents.map(e => e.status))];
                const eventTypes = [...new Set(mockEvents.map(e => e.eventType))];
                const serviceTypes = [...new Set(mockEvents.map(e => e.serviceType))];
                return { departments, statuses, eventTypes, serviceTypes };
            }, [mockEvents]);


            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };
            
            const handleClearFilters = () => {
                setFilters(initialFilters);
            };

            const filteredEvents = useMemo(() => {
                return mockEvents.filter(event => {
                    if (filters.date && event.date !== filters.date) return false;
                    if (filters.status !== 'Todos' && event.status !== filters.status) return false;
                    if (filters.eventType !== 'Todos' && event.eventType !== filters.eventType) return false;
                    if (filters.serviceType !== 'Todos' && event.serviceType !== filters.serviceType) return false;
                    if (filters.department !== 'Todos' && event.department !== filters.department) return false;
                    return true;
                });
            }, [filters, mockEvents]);
            
            const getStatusBadgeColor = (status) => {
                switch (status) {
                    case 'Aberta': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                    case 'Fechada': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                    case 'Em Andamento': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300';
                    default: return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
                }
            };
            
            const handleConfirmAction = () => {
                if (modalInfo.type === 'delete') {
                    setMockEvents(prevEvents => prevEvents.filter(event => event.id !== modalInfo.event.id));
                } else if (modalInfo.type === 'edit') {
                    setEditingEventId(modalInfo.event.id);
                    setView('addEvent');
                }
                setModalInfo({ isOpen: false, type: null, event: null }); // Close modal
            };

            return (
                <div>
                    <Header title="Editar Agendamentos" onBack={() => setView('dashboard')} />
                    <ConfirmationModal 
                        modalInfo={modalInfo}
                        onConfirm={handleConfirmAction}
                        onCancel={() => setModalInfo({ isOpen: false, type: null, event: null })}
                    />
                    <main className="p-4 pb-20 max-w-4xl mx-auto">
                        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                            <div className="flex justify-between items-center mb-3">
                                <h3 className="font-bold text-gray-800 dark:text-gray-200">Filtros</h3>
                                <button onClick={handleClearFilters} className="text-sm text-violet-600 dark:text-violet-400 hover:text-violet-800 dark:hover:text-violet-300 font-semibold">Limpar Filtros</button>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                                <input type="date" name="date" value={filters.date} onChange={handleFilterChange} className="border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-violet-300 focus:ring focus:ring-violet-200 focus:ring-opacity-50 dark:bg-gray-700 dark:text-gray-300"/>
                                <select name="status" value={filters.status} onChange={handleFilterChange} className="border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-violet-300 focus:ring focus:ring-violet-200 focus:ring-opacity-50 dark:bg-gray-700 dark:text-gray-300">
                                    <option value="Todos">Status (Todos)</option>
                                    {filterOptions.statuses.map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                                <select name="eventType" value={filters.eventType} onChange={handleFilterChange} className="border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-violet-300 focus:ring focus:ring-violet-200 focus:ring-opacity-50 dark:bg-gray-700 dark:text-gray-300">
                                    <option value="Todos">Tipo Evento (Todos)</option>
                                    {filterOptions.eventTypes.map(t => <option key={t} value={t}>{t}</option>)}
                                </select>
                                <select name="serviceType" value={filters.serviceType} onChange={handleFilterChange} className="border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-violet-300 focus:ring focus:ring-violet-200 focus:ring-opacity-50 dark:bg-gray-700 dark:text-gray-300">
                                    <option value="Todos">Tipo Culto (Todos)</option>
                                    {filterOptions.serviceTypes.map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                                <select name="department" value={filters.department} onChange={handleFilterChange} className="border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-violet-300 focus:ring focus:ring-violet-200 focus:ring-opacity-50 dark:bg-gray-700 dark:text-gray-300">
                                    <option value="Todos">Depto (Todos)</option>
                                    {filterOptions.departments.map(d => <option key={d} value={d}>{d}</option>)}
                                </select>
                            </div>
                        </div>
                        
                        <div className="mb-4 px-1">
                            <p className="text-sm text-gray-600 dark:text-gray-400"><strong className="text-gray-800 dark:text-gray-200">{filteredEvents.length}</strong> agendamentos encontrados.</p>
                        </div>

                        <div className="space-y-3">
                            {filteredEvents.map(event => (
                                <div key={event.id} className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 hover:shadow-lg transition">
                                    <div className="flex justify-between items-center">
                                        {/* Informa√ß√µes da Escala */}
                                        <div onClick={() => alert(`Visualizar detalhes de: ${event.name}`)} className="cursor-pointer flex-1 mr-4">
                                            <h4 className="font-bold text-gray-900 dark:text-gray-200">{event.name}</h4>
                                            <div className="flex items-center gap-3 mt-1 text-sm">
                                                 <p className="text-gray-500 dark:text-gray-400">{new Date(event.date + 'T00:00:00').toLocaleDateString('pt-BR')} - {event.department}</p>
                                                 <span className={`px-2 py-0.5 text-xs font-semibold rounded-full ${getStatusBadgeColor(event.status)}`}>
                                                    {event.status}
                                                </span>
                                            </div>
                                        </div>
                                        {/* Bot√µes de A√ß√£o */}
                                        <div className="flex gap-2">
                                            <button
                                                onClick={(e) => { 
                                                    e.stopPropagation();
                                                    setModalInfo({
                                                        isOpen: true,
                                                        type: 'edit',
                                                        event: event,
                                                        title: 'Confirmar Edi√ß√£o',
                                                        message: `Voc√™ tem certeza que deseja editar o agendamento "${event.name}"?`,
                                                        confirmText: 'Editar',
                                                        confirmColor: 'bg-violet-600 hover:bg-violet-700'
                                                    });
                                                }}
                                                className="p-2 text-violet-600 dark:text-violet-400 hover:bg-violet-100 dark:hover:bg-gray-700 rounded-full transition"
                                                title="Editar"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                                    <path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z" />
                                                </svg>
                                            </button>
                                            <button
                                                onClick={(e) => { 
                                                    e.stopPropagation(); 
                                                    setModalInfo({
                                                        isOpen: true,
                                                        type: 'delete',
                                                        event: event,
                                                        title: 'Confirmar Exclus√£o',
                                                        message: `Tem certeza que deseja excluir o agendamento "${event.name}"? Esta a√ß√£o n√£o pode ser desfeita.`,
                                                        confirmText: 'Excluir',
                                                        confirmColor: 'bg-red-600 hover:bg-red-700'
                                                    });
                                                }}
                                                className="p-2 text-red-500 hover:bg-red-100 dark:hover:bg-gray-700 rounded-full transition"
                                                title="Excluir"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                                    <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                             {filteredEvents.length === 0 && (
                                <p className="text-center text-gray-500 dark:text-gray-400 mt-6">Nenhum agendamento encontrado com os filtros selecionados.</p>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const GenerateRoteiroPage = ({ setView, mockEvents, mockDepartments }) => {
    const [selectedDate, setSelectedDate] = useState('2025-11-15');
    const [roteiroItems, setRoteiroItems] = useState([]);
    const [notificationModalOpen, setNotificationModalOpen] = useState(false);
    const [selectedDeptForNotification, setSelectedDeptForNotification] = useState('');

    // Mockando departamentos importantes para o resumo
    const priorityDepts = ['MINISTERIO DA MUSICA', 'MINISTERIO INFANTIL', 'DIACONATO', 'Sonoplastia'];

    // Fun√ß√£o para verificar se √© S√°bado
    const isSaturday = (dateString) => {
        if (!dateString) return false;
        const day = new Date(dateString + 'T00:00:00').getDay(); 
        return day === 6; 
    };

    // Filtra eventos para a data selecionada para compor o resumo
    const eventsForDate = useMemo(() => {
        return mockEvents.filter(event => event.date === selectedDate);
    }, [selectedDate, mockEvents]);

    // Calcula o status de cada departamento para o resumo
    const departmentStatus = useMemo(() => {
        const scheduled = new Map(eventsForDate.map(e => [e.department, e]));
        
        return priorityDepts.map(deptName => {
            const event = scheduled.get(deptName);
            return {
                name: deptName,
                isScheduled: !!event,
                details: event ? `${event.responsible} - ${event.description || 'Sem obs'}` : null
            };
        });
    }, [eventsForDate, priorityDepts]);

    // Mock Data do Roteiro
    useEffect(() => {
        const mockData = [
            { id: 1, time: '08:50', activity: 'M√∫sica ambiente', dept: 'Sonoplastia', detail: '[FIXO]', section: 'ES' },
            { id: 2, time: '09:00', activity: 'Boas-vindas e ora√ß√£o', dept: 'Equipe de Louvor', detail: 'Sergio - Raiane', section: 'ES' },
            { id: 3, time: '09:10', activity: 'Carta Mission√°ria', dept: 'Escola Sabatina', detail: 'Luciano', section: 'ES' },
            { id: 4, time: '10:33', activity: 'Hino Fixo - 21', dept: 'Equipe de Louvor', detail: 'Sergio - Raiane', section: 'CD' },
            { id: 5, time: '10:38', activity: 'Ora√ß√£o de Invoca√ß√£o', dept: 'Ancionato', detail: 'Anci√£o Azer√™do', section: 'CD' },
            { id: 6, time: '10:58', activity: 'Hino de Ofertas', dept: 'Equipe de Louvor', detail: 'Katia Prates', section: 'CD' },
            { id: 7, time: '11:08', activity: 'Serm√£o', dept: 'Pregadora', detail: 'Stefanie Batistoti', section: 'CD' },
        ];
        setRoteiroItems(mockData);
    }, [selectedDate]);

    const handleTimeChange = (id, newTime) => {
        setRoteiroItems(prevItems => prevItems.map(item => item.id === id ? { ...item, time: newTime } : item));
    };

    const handleOpenNotification = (deptName) => {
        setSelectedDeptForNotification(deptName);
        setNotificationModalOpen(true);
    };

    const handleDownload = (format) => alert(`Gerando arquivo ${format.toUpperCase()}...`);
    const handleSave = () => alert("Hor√°rios salvos com sucesso!");

    const saveButton = (
        <button onClick={handleSave} className="text-violet-600 dark:text-violet-400 font-semibold text-sm hover:bg-violet-50 dark:hover:bg-gray-700 px-3 py-1 rounded-full transition flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
            Salvar
        </button>
    );

    const RoteiroTable = ({ items, title, titleColor }) => (
        <div className="mb-6 overflow-x-auto border dark:border-gray-700 rounded-lg shadow-sm">
            {title && <div className={`text-center font-bold py-2 uppercase text-sm ${titleColor || 'bg-gray-200 text-gray-800'}`}>{title}</div>}
            <table className="min-w-full text-sm text-left bg-white dark:bg-gray-800">
                <thead className="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold border-b dark:border-gray-600">
                    <tr>
                        <th className="px-3 py-2 w-24 border-r dark:border-gray-600">Hora</th>
                        <th className="px-3 py-2 border-r dark:border-gray-600">Atividade</th>
                        <th className="px-3 py-2 border-r dark:border-gray-600">Departamento</th>
                        <th className="px-3 py-2">Respons√°vel/Detalhe</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                    {items.map((item, idx) => (
                        <tr key={item.id} className={idx % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-900'}>
                            <td className="px-3 py-1 border-r dark:border-gray-600">
                                <input type="text" value={item.time} onChange={(e) => handleTimeChange(item.id, e.target.value)} className="w-full font-bold text-gray-900 dark:text-white bg-transparent border-b border-transparent hover:border-gray-300 focus:border-violet-500 focus:outline-none text-center" />
                            </td>
                            <td className="px-3 py-2 border-r dark:border-gray-600 text-gray-800 dark:text-gray-200">{item.activity}</td>
                            <td className="px-3 py-2 border-r dark:border-gray-600 text-gray-600 dark:text-gray-400 text-xs">{item.dept}</td>
                            <td className="px-3 py-2 text-gray-600 dark:text-gray-400 text-xs">{item.detail}</td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );

    const renderRoteiroContent = () => {
        const isSat = isSaturday(selectedDate);
        if (isSat) {
            const escolaSabatina = roteiroItems.filter(i => i.section === 'ES');
            const cultoDivino = roteiroItems.filter(i => i.section === 'CD');
            return (
                <>
                    <RoteiroTable items={escolaSabatina} title="ESCOLA SABATINA" titleColor="bg-yellow-100 text-yellow-900" />
                    <RoteiroTable items={cultoDivino} title="CULTO DIVINO" titleColor="bg-yellow-100 text-yellow-900" />
                </>
            );
        } else {
            return <RoteiroTable items={roteiroItems} title={`PROGRAMA√á√ÉO - ${new Date(selectedDate + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'long' }).toUpperCase()}`} titleColor="bg-violet-100 text-violet-900" />;
        }
    };

    return (
        <div>
            <Header title="Gerar Roteiro" onBack={() => setView('dashboard')} rightAction={saveButton} />
            <AdvancedNotificationModal 
                isOpen={notificationModalOpen} 
                departmentName={selectedDeptForNotification} 
                onClose={() => setNotificationModalOpen(false)}
                onSend={(data) => console.log("Dados enviados:", data)}
            />
            
            <main className="p-2 pb-24 max-w-4xl mx-auto">
                {/* Seletor de Data */}
                <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-4">
                    <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Data do Evento:</label>
                    <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-violet-500" />
                </div>

                {/* Resumo dos Departamentos */}
                <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-4">
                    <h3 className="text-sm font-bold text-gray-700 dark:text-gray-300 mb-3 uppercase border-b pb-2 dark:border-gray-700">Status dos Departamentos</h3>
                    <div className="space-y-3">
                        {departmentStatus.map(dept => (
                            <div key={dept.name} className="flex items-center justify-between bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                                <div className="flex-1 pr-4">
                                    <p className="font-semibold text-gray-800 dark:text-gray-200 text-sm">{dept.name}</p>
                                    {dept.isScheduled ? (
                                        <p className="text-xs text-green-600 dark:text-green-400 flex items-center gap-1 mt-1">
                                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path></svg>
                                            Escala Recebida: <span className="text-gray-500 dark:text-gray-400 truncate max-w-[150px]">{dept.details}</span>
                                        </p>
                                    ) : (
                                        <p className="text-xs text-red-500 mt-1">Pendente de envio</p>
                                    )}
                                </div>
                                <div>
                                    {dept.isScheduled ? (
                                        <button className="text-gray-400 cursor-default" title="Ok">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                                        </button>
                                    ) : (
                                        <button 
                                            onClick={() => handleOpenNotification(dept.name)}
                                            className="flex items-center gap-1 bg-red-100 hover:bg-red-200 text-red-700 dark:bg-red-900/30 dark:hover:bg-red-900/50 dark:text-red-300 px-3 py-1.5 rounded-md text-xs font-bold transition"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                                            Notificar
                                        </button>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-2 mb-4">
                    {renderRoteiroContent()}
                </div>

                <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                     <h3 className="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4">Exportar Roteiro</h3>
                     <div className="flex flex-col sm:flex-row gap-3">
                        <button onClick={() => handleDownload('pdf')} className="flex-1 bg-red-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-700 transition shadow text-sm flex justify-center items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                            Gerar PDF
                        </button>
                        <button onClick={() => handleDownload('xls')} className="flex-1 bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 transition shadow text-sm flex justify-center items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            Gerar XLS
                        </button>
                    </div>
                </div>
            </main>
        </div>
    );
};

// --- COMPONENTE DETALHES DO EVENTO (CORRIGIDO) ---
        const EventDetailPage = ({ currentUser, eventId, setView, assignments, setAssignments, mockEvents, mockScales }) => {
            const event = mockEvents.find(e => e.id === eventId);
            const [isGenerating, setIsGenerating] = useState(false);
            const [generatedContent, setGeneratedContent] = useState('');
            const [modalTitle, setModalTitle] = useState('');

            // Se n√£o achar o evento, mostra mensagem e bot√£o voltar
            if (!event) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen p-4 text-gray-500">
                        <p className="mb-4">Evento n√£o encontrado.</p>
                        <button onClick={() => setView('dashboard')} className="text-violet-600 font-bold hover:underline">Voltar ao In√≠cio</button>
                    </div>
                );
            }

            // 1. Tratamento de Data Seguro
            const parseDateSafe = (dateStr) => {
                if (!dateStr) return new Date();
                if (typeof dateStr === 'string' && dateStr.includes('-')) {
                    const parts = dateStr.split('-');
                    return new Date(parts[0], parts[1] - 1, parts[2]);
                }
                return new Date(dateStr);
            };
            
            const eventDateObj = parseDateSafe(event.date);
            const eventDateString = eventDateObj.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            // 2. Cruzamento de Dados (Escalas do dia)
            const escalasDoEvento = mockScales.filter(scale => {
                let scaleDateStr = '';
                if (typeof scale.dataEvento === 'string') {
                    scaleDateStr = scale.dataEvento.split('T')[0];
                } else if (scale.dataEvento instanceof Date) {
                    scaleDateStr = scale.dataEvento.toISOString().split('T')[0];
                } else {
                    try { scaleDateStr = new Date(scale.dataEvento).toISOString().split('T')[0]; } catch(e) {}
                }
                return scaleDateStr === event.date;
            });

            // 3. Fun√ß√µes de IA e Utilit√°rios
            const callGeminiAPI = async (prompt) => {
                setIsGenerating(true);
                setGeneratedContent('');
                const apiKey = ""; // Insira sua chave aqui
                
                if(!apiKey) {
                    setTimeout(() => {
                        setGeneratedContent("IA simulada: Lembre-se de chegar 30min antes para a passagem de som. Deus aben√ßoe o servi√ßo!");
                        setIsGenerating(false);
                    }, 1500);
                    return;
                }

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    setGeneratedContent(text ? text.replace(/\*/g, '') : 'Erro ao gerar.');
                } catch (error) {
                    setGeneratedContent('Erro de conex√£o com a IA.');
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleGenerateInspiration = () => {
                setModalTitle('Mensagem Inspiradora ‚ú®');
                callGeminiAPI(`Mensagem b√≠blica curta para o evento ${event.name}`);
            };

            const handleGenerateReminder = () => {
                setModalTitle('Lembrete para Volunt√°rios ‚ú®');
                callGeminiAPI(`Lembrete whatsapp curto para volunt√°rios do evento ${event.name} dia ${eventDateString} √†s ${event.time}`);
            };

            const closeModal = () => { setModalTitle(''); setGeneratedContent(''); };
            
            const copyToClipboard = () => {
                navigator.clipboard.writeText(generatedContent).then(() => alert('Copiado!')).catch(() => alert('Erro ao copiar'));
            };

            const isConfirmed = event.status === 'Evento Confirmado';

            return (
                <div className="pb-20">
                    <Header title={event.name} onBack={() => setView('dashboard')} />
                    
                    {/* Modal de IA */}
                    {modalTitle && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 animate-fade-in-scale">
                            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md relative">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-gray-800 dark:text-gray-200">{modalTitle}</h3>
                                    <button onClick={closeModal} className="text-gray-400 text-2xl">&times;</button>
                                </div>
                                <div className="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg min-h-[100px] text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap">
                                    {isGenerating ? <div className="flex justify-center"><div className="loader w-6 h-6 border-2 border-violet-600 border-t-transparent"></div></div> : generatedContent}
                                </div>
                                {!isGenerating && generatedContent && (
                                    <div className="mt-4 flex justify-end gap-2">
                                        <button onClick={copyToClipboard} className="px-3 py-1.5 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300 font-medium">Copiar</button>
                                        <button onClick={closeModal} className="px-3 py-1.5 bg-violet-600 text-white rounded text-sm hover:bg-violet-700 font-medium">Fechar</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Banner / Capa */}
                    {event.attachment && (
                        <div className="w-full h-48 bg-gray-200 dark:bg-gray-700 relative overflow-hidden group">
                             {event.attachment.includes('drive.google.com') ? (
                                <img 
                                    src={getDriveDirectImage(event.attachment)} 
                                    className="w-full h-full object-cover" 
                                    alt="Capa"
                                    referrerPolicy="no-referrer"
                                    onError={(e) => e.target.src = 'https://via.placeholder.com/800x400?text=Arquivo+Anexado'} 
                                />
                             ) : (
                                <div className="flex items-center justify-center h-full text-gray-500 font-bold text-sm">Capa Indispon√≠vel</div>
                             )}
                             <a href={event.attachment} target="_blank" className="absolute bottom-4 right-4 bg-white/90 text-gray-800 px-3 py-1.5 rounded-full text-xs font-bold shadow-md hover:bg-white transition flex items-center gap-2">
                                üîó Abrir Arquivo
                             </a>
                        </div>
                    )}

                    <main className="p-4 max-w-4xl mx-auto -mt-6 relative z-10">
                        {/* Card Principal */}
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6 border-t-4 border-violet-500">
                            <div className="flex justify-between items-start mb-4">
                                <h1 className="text-xl font-bold text-gray-800 dark:text-gray-200 leading-tight">{event.name}</h1>
                                <span className={`px-2 py-1 rounded-md text-[10px] font-bold uppercase tracking-wide ${isConfirmed ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {isConfirmed ? 'Confirmado' : 'Cancelado'}
                                </span>
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 text-sm">
                                <div className="flex items-center gap-3 text-gray-600 dark:text-gray-300">
                                    <div className="w-8 h-8 rounded-full bg-violet-100 flex items-center justify-center text-violet-600"><svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></div>
                                    <div><p className="font-bold text-xs uppercase text-gray-400">Data</p><p className="capitalize font-medium">{eventDateString}</p></div>
                                </div>
                                <div className="flex items-center gap-3 text-gray-600 dark:text-gray-300">
                                    <div className="w-8 h-8 rounded-full bg-violet-100 flex items-center justify-center text-violet-600"><svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                                    <div><p className="font-bold text-xs uppercase text-gray-400">Hor√°rio</p><p className="font-medium">{event.time || 'A definir'}</p></div>
                                </div>
                                <div className="flex items-center gap-3 text-gray-600 dark:text-gray-300 sm:col-span-2">
                                    <div className="w-8 h-8 rounded-full bg-violet-100 flex items-center justify-center text-violet-600"><svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg></div>
                                    <div><p className="font-bold text-xs uppercase text-gray-400">Local</p><p className="font-medium">{event.location} <span className="text-gray-400">({event.branch || 'Matriz'})</span></p></div>
                                </div>
                            </div>
                            
                            {event.description && (
                                <div className="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg border border-gray-100 dark:border-gray-700">
                                    <h3 className="font-bold text-gray-800 dark:text-gray-200 mb-2 text-xs uppercase tracking-wide">Sobre o evento</h3>
                                    <p className="text-gray-600 dark:text-gray-400 text-sm whitespace-pre-wrap leading-relaxed">{event.description}</p>
                                </div>
                            )}
                        </div>
                        
                        {/* Ferramentas IA */}
                        <div className="mb-8">
                            <h3 className="text-sm font-bold text-gray-500 dark:text-gray-400 mb-3 uppercase px-1">Ferramentas com IA</h3>
                            <div className="flex flex-col sm:flex-row gap-3">
                                <button onClick={handleGenerateInspiration} className="flex-1 bg-white dark:bg-gray-800 border border-violet-200 dark:border-gray-700 text-violet-700 dark:text-violet-300 font-semibold py-3 px-4 rounded-xl text-sm hover:bg-violet-50 dark:hover:bg-gray-700 transition shadow-sm flex items-center justify-center gap-2">
                                    ‚ú® Gerar Mensagem
                                </button>
                                <button onClick={handleGenerateReminder} className="flex-1 bg-white dark:bg-gray-800 border border-violet-200 dark:border-gray-700 text-violet-700 dark:text-violet-300 font-semibold py-3 px-4 rounded-xl text-sm hover:bg-violet-50 dark:hover:bg-gray-700 transition shadow-sm flex items-center justify-center gap-2">
                                    üîî Criar Lembrete
                                </button>
                            </div>
                        </div>

                        {/* Escalas Cruzadas */}
                        <div>
                            <div className="flex justify-between items-end mb-4 px-1">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-gray-200">Escalas Confirmadas</h3>
                                <span className="text-xs font-bold bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-1 rounded-full">{escalasDoEvento.length}</span>
                            </div>
                            
                            {escalasDoEvento.length === 0 ? (
                                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-8 text-center border border-dashed border-gray-300 dark:border-gray-700">
                                    <div className="text-4xl mb-2">üìã</div>
                                    <p className="text-gray-500 dark:text-gray-400 font-medium">Nenhuma escala lan√ßada ainda.</p>
                                    <p className="text-xs text-gray-400 mt-1">As escalas desta data aparecer√£o aqui automaticamente.</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {escalasDoEvento.map((escala) => (
                                        <div key={escala.id} className="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 border-l-4 border-blue-500 flex justify-between items-center hover:shadow-md transition">
                                            <div>
                                                <p className="text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider mb-1">{escala.departamento}</p>
                                                <h4 className="font-bold text-gray-800 dark:text-gray-200 text-base">{escala.nomePessoa}</h4>
                                                <p className="text-sm text-gray-500 dark:text-gray-400">{escala.funcao}</p>
                                            </div>
                                            <span className={`text-[10px] font-bold px-2 py-1 rounded uppercase ${escala.status === 'Confirmado' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>
                                                {escala.status || 'Pendente'}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };
        
        const CalendarPage = ({ setView, setEventId, mockEvents }) => {
            const [currentDate, setCurrentDate] = useState(new Date(2025, 9, 15)); // Outubro de 2025
            const [filters, setFilters] = useState({ department: 'Todos', eventType: 'Todos' });

            const handleAction = (action) => alert(`Funcionalidade de "${action}" a ser implementada.`);
            
            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const filterOptions = useMemo(() => {
                const departments = ['Todos', ...new Set(mockEvents.map(e => e.department))];
                const eventTypes = ['Todos', ...new Set(mockEvents.map(e => e.eventType))];
                return { departments, eventTypes };
            }, [mockEvents]);

            const filteredEvents = useMemo(() => {
                return mockEvents.filter(event => {
                    if (filters.department !== 'Todos' && event.department !== filters.department) return false;
                    if (filters.eventType !== 'Todos' && event.eventType !== filters.eventType) return false;
                    return true;
                });
            }, [filters, mockEvents]);

            const calendarGrid = useMemo(() => {
                const year = currentDate.getFullYear(); const month = currentDate.getMonth();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const grid = []; let dayCounter = 1;
                for (let i = 0; i < 6; i++) {
                    const week = [];
                    for (let j = 0; j < 7; j++) {
                        if ((i === 0 && j < firstDayOfMonth) || dayCounter > daysInMonth) {
                            week.push({ day: null, dayOfWeek: j });
                        } else {
                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayCounter).padStart(2, '0')}`;
                            const eventsOnDay = filteredEvents.filter(e => e.date === dateStr);
                            week.push({ day: dayCounter, events: eventsOnDay, dayOfWeek: j });
                            dayCounter++;
                        }
                    }
                    grid.push(week);
                    if (dayCounter > daysInMonth) break;
                }
                return grid;
            }, [currentDate, filteredEvents]);

            const changeMonth = (offset) => setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() + offset, 1));
            
            return (
                <div>
                    <Header title="Calend√°rio" />
                    <main className="p-4 pb-20 max-w-4xl mx-auto">
                        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-4">
                            <div className="flex justify-between items-center mb-4">
                                <button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">&lt;</button>
                                <h2 className="text-lg font-bold text-gray-800 dark:text-gray-200 capitalize">{currentDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}</h2>
                                <button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">&gt;</button>
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 text-sm">
                                <select name="department" value={filters.department} onChange={handleFilterChange} className="border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-violet-300 focus:ring focus:ring-violet-200 focus:ring-opacity-50 dark:bg-gray-700 dark:text-gray-300">
                                    {filterOptions.departments.map(d => <option key={d} value={d}>{d === 'Todos' ? 'Departamento (Todos)' : d}</option>)}
                                </select>
                                <select name="eventType" value={filters.eventType} onChange={handleFilterChange} className="border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-violet-300 focus:ring focus:ring-violet-200 focus:ring-opacity-50 dark:bg-gray-700 dark:text-gray-300">
                                    {filterOptions.eventTypes.map(t => <option key={t} value={t}>{t === 'Todos' ? 'Tipo de Evento (Todos)' : t}</option>)}
                                </select>
                            </div>

                            <div className="mb-4">
                                <button onClick={() => handleAction('Sincronizar com Google')} className="w-full bg-blue-500 text-white text-sm font-semibold py-2 px-3 rounded-lg hover:bg-blue-600 transition">
                                    Sincronizar com Google Calendar
                                </button>
                            </div>

                            <div className="grid grid-cols-7 gap-1 text-center text-sm text-gray-500 dark:text-gray-400">
                                {['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'].map(day => <div key={day} className="font-semibold">{day}</div>)}
                                {calendarGrid.flat().map((cell, index) => (
                                    <div key={index} className={`h-20 border border-transparent rounded-md p-1 transition-colors duration-200 ${cell.day ? 'hover:bg-gray-100 dark:hover:bg-gray-700' : 'bg-gray-50 dark:bg-gray-800/50'} ${[0, 3, 6].includes(cell.dayOfWeek) && cell.day ? 'bg-violet-50 dark:bg-violet-900/30' : ''}`}>
                                        {cell.day && <span className="font-medium text-gray-700 dark:text-gray-300">{cell.day}</span>}
                                        {cell.events && cell.events.map(event => (
                                            <div key={event.id} onClick={() => { setEventId(event.id); setView('eventDetail'); }} className="bg-violet-200 text-violet-900 dark:bg-violet-800 dark:text-violet-200 text-xs rounded p-1 mt-1 truncate cursor-pointer hover:bg-violet-300 dark:hover:bg-violet-700">
                                                {event.name}
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };
        
        const ProfilePage = ({ currentUser, onLogout, onUpdateUser, setView }) => {
            const fileInputRef = useRef(null);

            const handlePhotoClick = () => {
                fileInputRef.current.click();
            };

            const handlePhotoChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const newAvatarUrl = URL.createObjectURL(file);
                    // Em um aplicativo real, voc√™ faria o upload deste arquivo para um servidor
                    // e obteria uma URL permanente. Para este prot√≥tipo, usamos uma URL de blob local.
                    onUpdateUser({ ...currentUser, avatar: newAvatarUrl });
                }
            };

            return (
                <div>
                    <Header title="Meu Perfil" />
                    <main className="p-4 pb-20 max-w-4xl mx-auto">
                        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 text-center">
                            <div className="relative w-24 h-24 mx-auto mb-4 group cursor-pointer" onClick={handlePhotoClick}>
                                <img src={currentUser.avatar} className="w-24 h-24 rounded-full mx-auto object-cover" alt="Avatar"/>
                                <div 
                                    className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 flex flex-col items-center justify-center rounded-full transition-opacity duration-300 opacity-0 group-hover:opacity-100"
                                    aria-label="Alterar foto de perfil"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-white mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                        <path strokeLinecap="round" strokeLinejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                        <path strokeLinecap="round" strokeLinejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    <span className="text-white text-xs font-bold">Alterar</span>
                                </div>
                                <input 
                                    type="file" 
                                    ref={fileInputRef} 
                                    onChange={handlePhotoChange}
                                    className="hidden" 
                                    accept="image/*"
                                />
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800 dark:text-gray-200">{currentUser.name}</h2>
                            <p className="text-gray-500 dark:text-gray-400">{currentUser.email}</p>
                            
                            <div className="mt-6 space-y-2">
                               <button onClick={() => setView('myScales')} className="w-full text-left bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 transition">Minhas Escalas</button>
                               <button onClick={() => setView('departmentData')} className="w-full text-left bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 transition">Dados Gerais do Depto.</button>
                               <button onClick={() => setView('settings')} className="w-full text-left bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 transition">Configura√ß√µes</button>
                            </div>

                            <button onClick={onLogout} className="mt-8 w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition">
                                Sair
                            </button>
                        </div>
                    </main>
                </div>
            );
        };

        const MyScalesPage = ({ currentUser, mockEvents, setView }) => {
            const initialFilters = { date: '', eventType: 'Todos', status: 'Todos', department: 'Todos', month: 'Todos' };
            const [filters, setFilters] = useState(initialFilters);
            
            const getStatusBadgeColor = (status) => {
                switch (status) {
                    case 'Aberta': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                    case 'Fechada': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                    case 'Em Andamento': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300';
                    default: return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
                }
            };
            
            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };
            
             const handleClearFilters = () => {
                setFilters(initialFilters);
            };

            const filteredEvents = useMemo(() => {
                // Para o admin, mostramos todas. Para outros usu√°rios, filtramos pelo nome.
                const userEvents = currentUser.id === 'admin' 
                    ? mockEvents 
                    : mockEvents.filter(event => event.responsible === currentUser.name);

                return userEvents.filter(event => {
                    if (filters.date && event.date !== filters.date) return false;
                    if (filters.eventType !== 'Todos' && event.eventType !== filters.eventType) return false;
                    if (filters.status !== 'Todos' && event.status !== filters.status) return false;
                    if (filters.department !== 'Todos' && event.department !== filters.department) return false;
                    if (filters.month !== 'Todos') {
                        const eventMonth = new Date(event.date + 'T00:00:00').getMonth() + 1;
                        if (eventMonth !== parseInt(filters.month)) return false;
                    }
                    return true;
                });
            }, [filters, mockEvents, currentUser]);
            
            const filterOptions = useMemo(() => {
                const events = currentUser.id === 'admin' ? mockEvents : mockEvents.filter(e => e.responsible === currentUser.name);
                const eventTypes = ['Todos', ...new Set(events.map(e => e.eventType))];
                const statuses = ['Todos', ...new Set(events.map(e => e.status))];
                const departments = ['Todos', ...new Set(events.map(e => e.department))];
                return { eventTypes, statuses, departments };
            }, [mockEvents, currentUser]);
            
            const monthOptions = [
                { value: 'Todos', label: 'M√™s (Todos)' }, { value: '1', label: 'Janeiro' }, { value: '2', label: 'Fevereiro' },
                { value: '3', label: 'Mar√ßo' }, { value: '4', label: 'Abril' }, { value: '5', label: 'Maio' },
                { value: '6', label: 'Junho' }, { value: '7', label: 'Julho' }, { value: '8', label: 'Agosto' },
                { value: '9', label: 'Setembro' }, { value: '10', label: 'Outubro' }, { value: '11', label: 'Novembro' },
                { value: '12', label: 'Dezembro' }
            ];

            return (
                <div>
                    <Header title="Minhas Escalas" onBack={() => setView('profile')} />
                     <main className="p-4 pb-20 max-w-4xl mx-auto">
                         <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                            <div className="flex justify-between items-center mb-3">
                                <h3 className="font-bold text-gray-800 dark:text-gray-200">Filtros</h3>
                                <button onClick={handleClearFilters} className="text-sm text-violet-600 dark:text-violet-400 hover:text-violet-800 dark:hover:text-violet-300 font-semibold">Limpar Filtros</button>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                                <input type="date" name="date" value={filters.date} onChange={handleFilterChange} className="border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-violet-300 focus:ring focus:ring-violet-200 focus:ring-opacity-50 dark:bg-gray-700 dark:text-gray-300"/>
                                <select name="eventType" value={filters.eventType} onChange={handleFilterChange} className="border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-gray-300">
                                    {filterOptions.eventTypes.map((opt, index) => <option key={`eventType-${opt}-${index}`} value={opt}>{opt === 'Todos' ? 'Tipo de Evento (Todos)' : opt}</option>)}
                                </select>
                                <select name="status" value={filters.status} onChange={handleFilterChange} className="border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-gray-300">
                                     {filterOptions.statuses.map((opt, index) => <option key={`status-${opt}-${index}`} value={opt}>{opt === 'Todos' ? 'Status (Todos)' : opt}</option>)}
                                </select>
                                <select name="department" value={filters.department} onChange={handleFilterChange} className="border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-gray-300">
                                     {filterOptions.departments.map((opt, index) => <option key={`department-${opt}-${index}`} value={opt}>{opt === 'Todos' ? 'Departamento (Todos)' : opt}</option>)}
                                </select>
                                <select name="month" value={filters.month} onChange={handleFilterChange} className="border-gray-300 dark:border-gray-600 rounded-md shadow-sm dark:bg-gray-700 dark:text-gray-300">
                                     {monthOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                                </select>
                            </div>
                        </div>

                        <div className="space-y-4">
                            {filteredEvents.length > 0 ? filteredEvents.map(event => (
                                <div key={event.id} className="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                                     <h4 className="font-bold text-gray-900 dark:text-gray-200">{event.name}</h4>
                                     <div className="flex items-center gap-3 mt-1 text-sm text-gray-500 dark:text-gray-400">
                                         <span>{new Date(event.date + 'T00:00:00').toLocaleDateString('pt-BR')}</span>
                                         <span>-</span>
                                         <span>{event.department}</span>
                                         <span className={`px-2 py-0.5 text-xs font-semibold rounded-full ${getStatusBadgeColor(event.status)}`}>
                                            {event.status}
                                        </span>
                                     </div>
                                     {event.description && <p className="text-sm text-gray-600 dark:text-gray-300 mt-2">{event.description}</p>}
                                </div>
                            )) : (
                                <p className="text-center text-gray-500 dark:text-gray-400 mt-8">Nenhuma escala encontrada com os filtros selecionados.</p>
                            )}
                        </div>
                     </main>
                </div>
            );
        };
        
        const DepartmentDataPage = ({ setView }) => {
            const [department, setDepartment] = useState('');
            const [leader, setLeader] = useState('');
            const [description, setDescription] = useState('');
            const [goals, setGoals] = useState('');
            const [importantEvents, setImportantEvents] = useState([{ date: '', observation: '' }]);
            const [apvEvents, setApvEvents] = useState([{ date: '', observation: '' }]);
            const [attachments, setAttachments] = useState([]);

            const handleEventChange = (index, field, value, type) => {
                const list = type === 'important' ? [...importantEvents] : [...apvEvents];
                list[index][field] = value;
                if (type === 'important') {
                    setImportantEvents(list);
                } else {
                    setApvEvents(list);
                }
            };

            const addEventField = (type) => {
                if (type === 'important') {
                    setImportantEvents([...importantEvents, { date: '', observation: '' }]);
                } else {
                    setApvEvents([...apvEvents, { date: '', observation: '' }]);
                }
            };

            const removeEventField = (index, type) => {
                const list = type === 'important' ? [...importantEvents] : [...apvEvents];
                if (list.length > 1) {
                    list.splice(index, 1);
                    if (type === 'important') {
                        setImportantEvents(list);
                    } else {
                        setApvEvents(list);
                    }
                }
            };

            const handleAttachmentChange = (e) => {
                setAttachments(prev => [...prev, ...Array.from(e.target.files)]);
            };
            
            const removeAttachment = (index) => {
                setAttachments(prev => prev.filter((_, i) => i !== index));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                // Simula√ß√£o de salvamento
                alert('Dados do departamento salvos com sucesso! (Simula√ß√£o)');
                console.log({
                    department, leader, description, goals, importantEvents, apvEvents, attachments
                });
                setView('profile');
            };

            return (
                <div>
                    <Header title="Dados Gerais do Depto." onBack={() => setView('profile')} />
                    <main className="p-4 pb-20 max-w-4xl mx-auto">
                        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div>
                                    <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Nome do Departamento <span className="text-red-500">*</span></label>
                                    <select value={department} onChange={e => setDepartment(e.target.value)} className="border-gray-300 rounded-md shadow-sm w-full dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600" required>
                                        <option value="" disabled>Selecione um departamento</option>
                                        {ALL_DEPARTMENTS_NAMES.map(dept => <option key={dept} value={dept}>{dept}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">L√≠der do Departamento <span className="text-red-500">*</span></label>
                                    <input type="text" value={leader} onChange={e => setLeader(e.target.value)} className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 dark:border-gray-600" required />
                                </div>
                                <div>
                                    <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Descri√ß√£o do Departamento <span className="text-red-500">*</span></label>
                                    <textarea value={description} onChange={e => setDescription(e.target.value)} rows="4" className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 dark:border-gray-600" required></textarea>
                                </div>
                                <div>
                                    <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Objetivos do Ano <span className="text-red-500">*</span></label>
                                    <textarea value={goals} onChange={e => setGoals(e.target.value)} rows="4" className="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 dark:border-gray-600" required></textarea>
                                </div>
                                
                                <div className="border-t dark:border-gray-700 pt-6">
                                    <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Eventos Importantes</label>
                                    {importantEvents.map((event, index) => (
                                        <div key={index} className="flex items-center gap-2 mb-2">
                                            <input type="date" value={event.date} onChange={e => handleEventChange(index, 'date', e.target.value, 'important')} className="border-gray-300 rounded-md shadow-sm w-1/3 py-2 px-3 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600" />
                                            <input type="text" placeholder="Observa√ß√£o do evento" value={event.observation} onChange={e => handleEventChange(index, 'observation', e.target.value, 'important')} className="shadow appearance-none border rounded-md w-2/3 py-2 px-3 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600" />
                                            {importantEvents.length > 1 && <button type="button" onClick={() => removeEventField(index, 'important')} className="text-red-500 hover:text-red-700 p-2 rounded-full">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clipRule="evenodd" /></svg>
                                            </button>}
                                        </div>
                                    ))}
                                    <button type="button" onClick={() => addEventField('important')} className="text-sm text-violet-600 dark:text-violet-400 font-semibold hover:text-violet-800 dark:hover:text-violet-300">+ Adicionar Evento</button>
                                </div>

                                <div className="border-t dark:border-gray-700 pt-6">
                                    <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Eventos da APV</label>
                                     {apvEvents.map((event, index) => (
                                        <div key={index} className="flex items-center gap-2 mb-2">
                                            <input type="date" value={event.date} onChange={e => handleEventChange(index, 'date', e.target.value, 'apv')} className="border-gray-300 rounded-md shadow-sm w-1/3 py-2 px-3 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600" />
                                            <input type="text" placeholder="Observa√ß√£o do evento" value={event.observation} onChange={e => handleEventChange(index, 'observation', e.target.value, 'apv')} className="shadow appearance-none border rounded-md w-2/3 py-2 px-3 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600" />
                                            {apvEvents.length > 1 && <button type="button" onClick={() => removeEventField(index, 'apv')} className="text-red-500 hover:text-red-700 p-2 rounded-full">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clipRule="evenodd" /></svg>
                                            </button>}
                                        </div>
                                    ))}
                                    <button type="button" onClick={() => addEventField('apv')} className="text-sm text-violet-600 dark:text-violet-400 font-semibold hover:text-violet-800 dark:hover:text-violet-300">+ Adicionar Evento</button>
                                </div>

                                <div className="border-t dark:border-gray-700 pt-6">
                                    <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Anexos Gerais</label>
                                    <input type="file" multiple onChange={handleAttachmentChange} className="text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 dark:file:bg-violet-900/50 file:text-violet-700 dark:file:text-violet-300 hover:file:bg-violet-100 dark:hover:file:bg-violet-900 mb-2" />
                                    <div className="space-y-2 mt-2">
                                        {attachments.map((file, index) => (
                                            <div key={index} className="flex items-center justify-between bg-gray-100 dark:bg-gray-700 p-2 rounded-md text-sm">
                                                <span className="text-gray-700 dark:text-gray-300 truncate mr-2">{file.name}</span>
                                                <button type="button" onClick={() => removeAttachment(index)} className="text-red-500 hover:text-red-700 font-semibold">Remover</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="pt-4">
                                    <button type="submit" className="w-full bg-violet-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-violet-700 transition duration-300 shadow-lg">
                                        Salvar Dados
                                    </button>
                                </div>
                            </form>
                        </div>
                    </main>
                </div>
            );
        };
        
        const SettingsPage = ({ currentUser, setView, setManagingTable, theme, setTheme, onUpdatePassword }) => {
            const [activeTab, setActiveTab] = useState('aparencia');
            const [novaSenha, setNovaSenha] = useState('');
            const [confirmarSenha, setConfirmarSenha] = useState('');
            const [showCurrentPassword, setShowCurrentPassword] = useState(false);
            const [showNewPassword, setShowNewPassword] = useState(false);
            const [showConfirmPassword, setShowConfirmPassword] = useState(false);
            const [modalInfo, setModalInfo] = useState({ isOpen: false });

            const handleOpenTable = (tableName) => {
                setManagingTable(tableName);
                setView('manageTable');
            };

            const settingsOptions = [
                { id: 'seguranca', label: 'Seguran√ßa' },
                { id: 'notificacoes', label: 'Notifica√ß√µes' },
                { id: 'aparencia', label: 'Apar√™ncia' },
                { id: 'informacoes', label: 'Informa√ß√µes Gerais' },
                { id: 'integracoes', label: 'Integra√ß√µes' },
            ];
            
            const handleThemeToggle = () => {
                setTheme(prevTheme => prevTheme === 'light' ? 'dark' : 'light');
            };

            const handlePasswordSubmit = (e) => {
                e.preventDefault();
                if (novaSenha !== confirmarSenha) {
                    alert("As novas senhas n√£o correspondem.");
                    return;
                }
                if (novaSenha.length < 3) {
                    alert("A nova senha deve ter pelo menos 3 caracteres.");
                    return;
                }
                
                setModalInfo({
                    isOpen: true,
                    title: 'Confirmar Altera√ß√£o de Senha',
                    message: 'Voc√™ tem certeza que deseja alterar sua senha? Esta a√ß√£o √© permanente.',
                    confirmText: 'Alterar Senha',
                    confirmColor: 'bg-violet-600 hover:bg-violet-700'
                });
            };
            
            const confirmPasswordChange = () => {
                onUpdatePassword(novaSenha);
                alert("Senha alterada com sucesso!");
                setNovaSenha('');
                setConfirmarSenha('');
                setModalInfo({ isOpen: false });
            };

            const renderContent = () => {
                switch (activeTab) {
                    case 'seguranca':
                        return (
                            <div>
                                <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Seguran√ßa</h3>
                                <form onSubmit={handlePasswordSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-1 dark:text-gray-300">Senha Atual</label>
                                        <div className="relative">
                                            <input 
                                              type={showCurrentPassword ? "text" : "password"} 
                                              value={currentUser.senha} 
                                              readOnly 
                                              className="w-full border-gray-300 rounded-md shadow-sm bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300"
                                            />
                                            <button type="button" onClick={() => setShowCurrentPassword(!showCurrentPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                                                {showCurrentPassword ? <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l18 18" /></svg> : <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>}
                                            </button>
                                        </div>
                                    </div>
                                    <div className="relative">
                                        <label className="block text-sm font-bold mb-1 dark:text-gray-300">Nova Senha</label>
                                        <input type={showNewPassword ? "text" : "password"} value={novaSenha} onChange={(e) => setNovaSenha(e.target.value)} placeholder="Nova Senha" className="w-full border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"/>
                                         <button type="button" onClick={() => setShowNewPassword(!showNewPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5 pt-6">
                                            {showNewPassword ? <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l18 18" /></svg> : <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>}
                                        </button>
                                    </div>
                                    <div className="relative">
                                        <label className="block text-sm font-bold mb-1 dark:text-gray-300">Confirmar Nova Senha</label>
                                        <input type={showConfirmPassword ? "text" : "password"} value={confirmarSenha} onChange={(e) => setConfirmarSenha(e.target.value)} placeholder="Confirmar Nova Senha" className="w-full border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"/>
                                         <button type="button" onClick={() => setShowConfirmPassword(!showConfirmPassword)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5 pt-6">
                                            {showConfirmPassword ? <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l18 18" /></svg> : <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>}
                                        </button>
                                    </div>
                                    <button type="submit" className="bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:bg-violet-700">Salvar Nova Senha</button>
                                </form>
                                {currentUser.id === 'admin' && (
                                    <div className="mt-8 pt-6 border-t dark:border-gray-700">
                                         <h4 className="font-semibold mb-4 dark:text-gray-300">Gerenciamento de Usu√°rios</h4>
                                         <p className="text-sm text-gray-600 dark:text-gray-400">Aqui o administrador poder√° adicionar, editar e remover usu√°rios do sistema.</p>
                                         {/* Placeholder para gerenciamento de usu√°rios */}
                                    </div>
                                )}
                            </div>
                        );
                    case 'notificacoes':
                         return (
                            <div>
                                <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Notifica√ß√µes</h3>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                                        <label htmlFor="email-notifications" className="font-medium text-gray-700 dark:text-gray-300">Notifica√ß√µes por E-mail</label>
                                        <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                            <input type="checkbox" name="toggle" id="email-notifications" className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                            <label htmlFor="email-notifications" className="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                        </div>
                                    </div>
                                     <div className="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                                        <label htmlFor="push-notifications" className="font-medium text-gray-700 dark:text-gray-300">Notifica√ß√µes Push</label>
                                         <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                            <input type="checkbox" name="toggle" id="push-notifications" className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" defaultChecked/>
                                            <label htmlFor="push-notifications" className="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                        </div>
                                    </div>
                                </div>
                                <style>{`
                                    .toggle-checkbox:checked { right: 0; border-color: #6d28d9; }
                                    .toggle-checkbox:checked + .toggle-label { background-color: #6d28d9; }
                                `}</style>
                            </div>
                        );
                    case 'aparencia':
                         return (
                            <div>
                                <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Apar√™ncia</h3>
                                 <div className="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                                    <label htmlFor="dark-mode" className="font-medium text-gray-700 dark:text-gray-300">Modo Escuro</label>
                                    <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="toggle" id="dark-mode" className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" onChange={handleThemeToggle} checked={theme === 'dark'} />
                                        <label htmlFor="dark-mode" className="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-gray-600 cursor-pointer"></label>
                                    </div>
                                </div>
                                <style>{`
                                    .toggle-checkbox:checked { right: 0; border-color: #6d28d9; }
                                    .toggle-checkbox:checked + .toggle-label { background-color: #6d28d9; }
                                `}</style>
                            </div>
                        );
                    case 'informacoes':
                         return (
                            <div>
                                <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Informa√ß√µes Gerais</h3>
                                <div className="text-gray-700 dark:text-gray-300">
                                    <p><strong>Vers√£o do App:</strong> 1.0.0 (Prot√≥tipo)</p>
                                    <p><strong>Desenvolvido por:</strong> Seu Time de Desenvolvimento</p>
                                    <a href="#" className="text-violet-600 dark:text-violet-400 hover:underline mt-2 inline-block">Termos de Servi√ßo</a><br/>
                                    <a href="#" className="text-violet-600 dark:text-violet-400 hover:underline">Pol√≠tica de Privacidade</a>
                                </div>
                            </div>
                        );
                    case 'integracoes':
                        return (
                             <div>
                                <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Integra√ß√µes</h3>
                                {currentUser.id === 'admin' ? (
                                    <div className="space-y-6">
                                        <div>
                                            <h4 className="font-semibold dark:text-gray-300">Atualiza√ß√£o de Tabelas Mestre</h4>
                                            <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">Realize o deploy de atualiza√ß√µes para as tabelas de dados principais do sistema.</p>
                                            
                                            <div className="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg flex justify-between items-center mb-2">
                                                <div>
                                                    <p className="font-medium text-gray-800 dark:text-gray-200">Tabela de Eventos</p>
                                                    <p className="text-xs text-gray-500 dark:text-gray-400">Atualiza os tipos de eventos dispon√≠veis.</p>
                                                </div>
                                                <button 
                                                    onClick={() => handleOpenTable('EVENTOS')} 
                                                    className="bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:bg-violet-700 w-32 text-center"
                                                >
                                                    Abrir Tabela
                                                </button>
                                            </div>

                                            <div className="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg flex justify-between items-center mb-2">
                                                 <div>
                                                    <p className="font-medium text-gray-800 dark:text-gray-200">Tabela de Departamentos</p>
                                                    <p className="text-xs text-gray-500 dark:text-gray-400">Atualiza a lista de departamentos e contatos.</p>
                                                </div>
                                                <button 
                                                    onClick={() => handleOpenTable('DEPARTAMENTOS')}
                                                    className="bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:bg-violet-700 w-32 text-center"
                                                >
                                                    Abrir Tabela
                                                </button>
                                            </div>

                                             <div className="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg flex justify-between items-center">
                                                <div>
                                                    <p className="font-medium text-gray-800 dark:text-gray-200">Tabela de Acesso</p>
                                                    <p className="text-xs text-gray-500 dark:text-gray-400">Atualiza perfis e permiss√µes de usu√°rios.</p>
                                                </div>
                                                <button 
                                                    onClick={() => handleOpenTable('ACESSO')}
                                                    className="bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:bg-violet-700 w-32 text-center"
                                                >
                                                   Abrir Tabela
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                     <div>
                                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">Conecte sua conta com outros servi√ßos para facilitar seu dia a dia.</p>
                                        <button className="w-full bg-blue-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-blue-600 transition">
                                            Sincronizar com Google Calendar
                                        </button>
                                    </div>
                                )}
                            </div>
                        );
                    default: return null;
                }
            };
            
            return (
                <div>
                    <Header title="Configura√ß√µes" onBack={() => setView('profile')} />
                     <ConfirmationModal modalInfo={modalInfo} onConfirm={confirmPasswordChange} onCancel={() => setModalInfo({isOpen: false})} />
                    <main className="p-4 pb-20 max-w-4xl mx-auto">
                        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md md:flex">
                            <aside className="md:w-1/4 p-4 border-b md:border-b-0 md:border-r dark:border-gray-700">
                                <nav className="space-y-1">
                                    {settingsOptions.map(opt => (
                                        <button 
                                            key={opt.id}
                                            onClick={() => setActiveTab(opt.id)}
                                            className={`w-full text-left px-3 py-2 rounded-md text-sm font-medium transition ${activeTab === opt.id ? 'bg-violet-100 dark:bg-violet-900/50 text-violet-700 dark:text-violet-300' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-gray-200'}`}
                                        >
                                            {opt.label}
                                        </button>
                                    ))}
                                </nav>
                            </aside>
                            <div className="p-6 flex-1">
                                {renderContent()}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };
        
       const ManageTablePage = ({ tableName, setView, mockEvents, currentUser, setMockEvents, mockDepartments, setMockDepartments, mockAccess, setMockAccess }) => {
            const [currentRecords, setCurrentRecords] = useState([]);
            const [newRecords, setNewRecords] = useState([]);
            const [newRecordInput, setNewRecordInput] = useState({});
            const [updateStatus, setUpdateStatus] = useState('idle'); // idle, loading, success, error
            const [logMessage, setLogMessage] = useState('');
            const [editingRecordId, setEditingRecordId] = useState(null);
            const [editedRecordData, setEditedRecordData] = useState(null);
            const [modalInfo, setModalInfo] = useState({ isOpen: false });

            useEffect(() => {
                setEditingRecordId(null);
                setEditedRecordData(null);
                setNewRecords([]);

                if (tableName === 'EVENTOS') {
                    const eventRecords = mockEvents.map(e => ({ RE_ID_EVENTOS: e.id, EV_NOME_EVENTO: e.name, EV_TIPO_EVENTO: e.eventType, ...e.logInfo }));
                    setCurrentRecords(eventRecords);
                    setNewRecordInput({ EV_NOME_EVENTO: '', EV_TIPO_EVENTO: '' });
                } else if (tableName === 'DEPARTAMENTOS') {
                    setCurrentRecords(Object.values(mockDepartments));
                    setNewRecordInput({ DE_NOME_DEPARTAMENTO: '', DE_LIDER_DEPTO: '', DE_ASSOCIADO_DEPTO: '', DE_CONTATO: '', DE_ANCIAO_LIDER: '', DE_EMAIL: '' });
                } else if (tableName === 'ACESSO') {
                    setCurrentRecords(Object.values(mockAccess));
                    setNewRecordInput({ AC_LOGIN: '', AC_SENHA: '', AC_DEPARTAMENTO: '', AC_RESP: '', AC_EMAIL: '', AC_APROVACAO: 'P', AC_NOTIFICACAO: '' });
                }
                else {
                    setCurrentRecords([]);
                    setNewRecordInput({});
                }
            }, [tableName, mockEvents, mockDepartments, mockAccess]);

            const handleInputChange = e => setNewRecordInput(prev => ({ ...prev, [e.target.name]: e.target.value }));

            const handleAddItem = (e) => {
                e.preventDefault();
                let requiredFields;
                if (tableName === 'DEPARTAMENTOS') {
                    requiredFields = ['DE_NOME_DEPARTAMENTO', 'DE_LIDER_DEPTO', 'DE_ASSOCIADO_DEPTO', 'DE_CONTATO', 'DE_ANCIAO_LIDER', 'DE_EMAIL'];
                } else if (tableName === 'ACESSO') {
                    requiredFields = ['AC_LOGIN', 'AC_SENHA', 'AC_DEPARTAMENTO', 'AC_RESP', 'AC_EMAIL', 'AC_APROVACAO'];
                } else { // EVENTOS
                    requiredFields = ['EV_NOME_EVENTO', 'EV_TIPO_EVENTO'];
                }
                
                if (requiredFields.some(field => !newRecordInput[field] || String(newRecordInput[field]).trim() === '')) {
                     alert('Todos os campos obrigat√≥rios devem ser preenchidos.');
                     return;
                }
                
                setNewRecords(prev => [...prev, { tempId: `new-${Date.now()}`, ...newRecordInput }]);
                
                // Reset form
                if (tableName === 'DEPARTAMENTOS') setNewRecordInput({ DE_NOME_DEPARTAMENTO: '', DE_LIDER_DEPTO: '', DE_ASSOCIADO_DEPTO: '', DE_CONTATO: '', DE_ANCIAO_LIDER: '', DE_EMAIL: '' });
                else if (tableName === 'ACESSO') setNewRecordInput({ AC_LOGIN: '', AC_SENHA: '', AC_DEPARTAMENTO: '', AC_RESP: '', AC_EMAIL: '', AC_APROVACAO: 'P', AC_NOTIFICACAO: '' });
                else setNewRecordInput({ EV_NOME_EVENTO: '', EV_TIPO_EVENTO: '' });
            };
            
            const handleRemoveNewItem = (tempId) => setNewRecords(newRecords.filter(item => item.tempId !== tempId));

            const handleUpdate = () => {
                if (newRecords.length === 0) {
                    alert("Nenhum novo registro para adicionar.");
                    return;
                }
                setUpdateStatus('loading');
                
                setTimeout(() => {
                    if (Math.random() > 0.3) { // Success
                        setUpdateStatus('success');
                        const now = new Date().toLocaleString('pt-BR');
                        
                        if (tableName === 'DEPARTAMENTOS') {
                            const newDeptEntries = newRecords.map(rec => { const newId = `dept${Date.now() + Math.random()}`; return { ...rec, DE_ID_DEPTO: newId, logInfo: { RE_DATA_UPDATE: now, RE_DATA_MODIFICACAO: now, RE_USUARIO_LOGADO: currentUser.name } }; });
                            setMockDepartments(prev => { const newDepts = {...prev}; newDeptEntries.forEach(d => { newDepts[d.DE_ID_DEPTO] = d; }); return newDepts; });
                        } else if (tableName === 'EVENTOS') {
                             const newMockEvents = newRecords.map(rec => {
                                const newId = `evt${Date.now() + Math.random()}`;
                                return { id: newId, name: rec.EV_NOME_EVENTO, eventType: rec.EV_TIPO_EVENTO, date: 'N/A', time: 'N/A', location: 'N/A', description: '', status: 'Planejada', logInfo: { RE_DATA_UPDATE: now, RE_DATA_MODIFICACAO: now, RE_USUARIO_LOGADO: currentUser.name }};
                             });
                             setMockEvents(prev => [...prev, ...newMockEvents]);
                        } else if (tableName === 'ACESSO') {
                            const newAccessEntries = newRecords.map(rec => { const newId = `acc${Date.now() + Math.random()}`; return { ...rec, AC_ID: newId, logInfo: { RE_DATA_UPDATE: now, RE_DATA_MODIFICACAO: now, RE_USUARIO_LOGADO: currentUser.name } }; });
                            setMockAccess(prev => { const newAccess = {...prev}; newAccessEntries.forEach(a => { newAccess[a.AC_ID] = a; }); return newAccess; });
                        }
                    } else { // Error
                        setUpdateStatus('error');
                        const now = new Date().toLocaleString('pt-BR');
                        setLogMessage(`[${now}] ERROR: 500\nFalha ao executar INSERT na tabela ${tableName}.\nUsu√°rio: ${currentUser.name}\nVerifique a integridade dos dados e a conex√£o.`);
                    }
                }, 2000);
            };
            
            const resetAndUpdate = () => {
                setUpdateStatus('idle');
                setNewRecords([]);
            };

            const handleStartEdit = (record) => {
                const id = tableName === 'EVENTOS' ? record.RE_ID_EVENTOS : (tableName === 'DEPARTAMENTOS' ? record.DE_ID_DEPTO : record.AC_ID);
                setEditingRecordId(id);
                setEditedRecordData({ ...record });
            };

            const handleCancelEdit = () => {
                setEditingRecordId(null);
                setEditedRecordData(null);
            };

            const handleEditedInputChange = (e) => {
                const { name, value } = e.target;
                setEditedRecordData(prev => ({ ...prev, [name]: value }));
            };
            
            const handleConfirmAction = () => {
                const { type, record } = modalInfo;
                if (type === 'save') {
                    const now = new Date().toLocaleString('pt-BR');
                    const updatedLogInfo = { ...record.logInfo, RE_DATA_MODIFICACAO: now, RE_USUARIO_LOGADO: currentUser.name };
                    
                    if (tableName === 'DEPARTAMENTOS') {
                        const updatedRecord = { ...editedRecordData, logInfo: updatedLogInfo };
                        setMockDepartments(prev => ({...prev, [record.DE_ID_DEPTO]: updatedRecord }));
                    } else if (tableName === 'ACESSO') {
                        const updatedRecord = { ...editedRecordData, logInfo: updatedLogInfo };
                        setMockAccess(prev => ({...prev, [record.AC_ID]: updatedRecord }));
                    } else { // EVENTOS
                         const updatedRecord = { ...record, ...editedRecordData, RE_DATA_MODIFICACAO: now, RE_USUARIO_LOGADO: currentUser.name };
                         setMockEvents(mockEvents.map(e => e.id === record.RE_ID_EVENTOS ? { ...e, name: updatedRecord.EV_NOME_EVENTO, eventType: updatedRecord.EV_TIPO_EVENTO, logInfo: { ...e.logInfo, RE_DATA_MODIFICACAO: now, RE_USUARIO_LOGADO: currentUser.name } } : e));
                    }
                    handleCancelEdit();
                } else if (type === 'delete') {
                    if (tableName === 'DEPARTAMENTOS') {
                        setMockDepartments(prev => { const newDepts = {...prev}; delete newDepts[record.DE_ID_DEPTO]; return newDepts; });
                    } else if (tableName === 'ACESSO') {
                        setMockAccess(prev => { const newAccess = {...prev}; delete newAccess[record.AC_ID]; return newAccess; });
                    } else { // EVENTOS
                        setMockEvents(mockEvents.filter(e => e.id !== record.RE_ID_EVENTOS));
                    }
                }
                setModalInfo({ isOpen: false });
            };

            const title = `Gerenciar Tabela: ${tableName.charAt(0) + tableName.slice(1).toLowerCase()}`;

            return (
                 <div>
                    <Header title={title} onBack={() => setView('settings')} />
                    <ConfirmationModal modalInfo={modalInfo} onConfirm={handleConfirmAction} onCancel={() => setModalInfo({isOpen: false})} />
                    <UpdateResultModal status={updateStatus} logMessage={logMessage} onRetry={resetAndUpdate} onGoBack={() => setView('settings')} />
                    <main className="p-4 pb-20 max-w-4xl mx-auto">
                        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            
                            {tableName === 'DEPARTAMENTOS' ? (
                                <DepartmentForm newRecordInput={newRecordInput} handleInputChange={handleInputChange} handleAddItem={handleAddItem} />
                            ) : tableName === 'EVENTOS' ? (
                                <EventForm newRecordInput={newRecordInput} handleInputChange={handleInputChange} handleAddItem={handleAddItem} />
                            ) : tableName === 'ACESSO' ? (
                                <AccessForm newRecordInput={newRecordInput} handleInputChange={handleInputChange} handleAddItem={handleAddItem} mockDepartments={mockDepartments} />
                            ) : (
                                <p className="text-center text-gray-500">Tabela n√£o suportada para lan√ßamento: {tableName}</p>
                            )}

                            {newRecords.length > 0 && (
                                <div className="mt-4">
                                    <h4 className="font-semibold text-gray-600 dark:text-gray-400 text-sm mb-2">Registros a serem inclu√≠dos:</h4>
                                    <div className="space-y-2">
                                        {newRecords.map(item => (
                                            <div key={item.tempId} className="bg-violet-50 dark:bg-violet-900/50 p-2 rounded-md flex justify-between items-center text-sm">
                                                <span className="font-semibold text-violet-800 dark:text-violet-300">{item.DE_NOME_DEPARTAMENTO || item.EV_NOME_EVENTO || item.AC_LOGIN}</span>
                                                <button onClick={() => handleRemoveNewItem(item.tempId)} className="text-red-500 hover:text-red-700 text-xs font-semibold">REMOVER</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            <div className="my-8">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4">Registros Atuais na Tabela</h3>
                                <div className="max-h-96 overflow-y-auto border dark:border-gray-700 rounded-lg">
                                    {tableName === 'DEPARTAMENTOS' ? (
                                        <DepartmentTable records={currentRecords} editingId={editingRecordId} editedData={editedRecordData} onEditChange={handleEditedInputChange} onStartEdit={handleStartEdit} onCancelEdit={handleCancelEdit} setModalInfo={setModalInfo} />
                                    ) : tableName === 'EVENTOS' ? (
                                        <EventTable records={currentRecords} editingId={editingRecordId} editedData={editedRecordData} onEditChange={handleEditedInputChange} onStartEdit={handleStartEdit} onCancelEdit={handleCancelEdit} setModalInfo={setModalInfo}/>
                                    ) : tableName === 'ACESSO' ? (
                                         <AccessTable records={currentRecords} editingId={editingRecordId} editedData={editedRecordData} onEditChange={handleEditedInputChange} onStartEdit={handleStartEdit} onCancelEdit={handleCancelEdit} setModalInfo={setModalInfo} mockDepartments={mockDepartments}/>
                                    ) : (
                                        <p className="p-4 text-center text-gray-500">Nenhum registro para exibir para a tabela {tableName}.</p>
                                    )}
                                </div>
                            </div>
                           
                            <button
                                onClick={handleUpdate}
                                disabled={updateStatus === 'loading' || newRecords.length === 0}
                                className="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                            >
                                {updateStatus === 'loading' ? (
                                    <><div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div><span>Atualizando...</span></>
                                ) : ( 'Atualizar Tabela com Novos Registros' )}
                            </button>
                        </div>
                    </main>
                </div>
            );
        };
        
        const EventForm = ({ newRecordInput, handleInputChange, handleAddItem }) => (
            <div className="mb-8">
                <h3 className="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4">Grid de Lan√ßamento</h3>
                <form onSubmit={handleAddItem} className="grid grid-cols-1 md:grid-cols-3 gap-3 items-end bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                    <div className="md:col-span-1">
                        <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Nome do Evento</label>
                        <input type="text" name="EV_NOME_EVENTO" value={newRecordInput.EV_NOME_EVENTO || ''} onChange={handleInputChange} placeholder="Ex: Culto de Santa Ceia" className="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-violet-500" />
                    </div>
                    <div className="md:col-span-1">
                        <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Tipo do Evento</label>
                        <input type="text" name="EV_TIPO_EVENTO" value={newRecordInput.EV_TIPO_EVENTO || ''} onChange={handleInputChange} placeholder="Ex: Culto" className="shadow-sm appearance-none border rounded-md w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-violet-500" />
                    </div>
                    <button type="submit" className="md:col-span-1 bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-violet-700 transition h-10">Adicionar √† Lista</button>
                </form>
            </div>
        );
        
        const DepartmentForm = ({ newRecordInput, handleInputChange, handleAddItem }) => (
             <div className="mb-8">
                <h3 className="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4">Grid de Lan√ßamento</h3>
                <form onSubmit={handleAddItem} className="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1">Nome do Depto.</label><input type="text" name="DE_NOME_DEPARTAMENTO" value={newRecordInput.DE_NOME_DEPARTAMENTO || ''} onChange={handleInputChange} className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required /></div>
                        <div><label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1">L√≠der</label><input type="text" name="DE_LIDER_DEPTO" value={newRecordInput.DE_LIDER_DEPTO || ''} onChange={handleInputChange} className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required /></div>
                        <div><label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1">Associado</label><input type="text" name="DE_ASSOCIADO_DEPTO" value={newRecordInput.DE_ASSOCIADO_DEPTO || ''} onChange={handleInputChange} className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required /></div>
                        <div><label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1">Anci√£o Respons√°vel</label><input type="text" name="DE_ANCIAO_LIDER" value={newRecordInput.DE_ANCIAO_LIDER || ''} onChange={handleInputChange} className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required /></div>
                        <div><label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1">Contato (WhatsApp)</label><input type="tel" name="DE_CONTATO" value={newRecordInput.DE_CONTATO || ''} onChange={handleInputChange} className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required /></div>
                        <div><label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1">E-mail</label><input type="email" name="DE_EMAIL" value={newRecordInput.DE_EMAIL || ''} onChange={handleInputChange} className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required /></div>
                    </div>
                    <button type="submit" className="w-full bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-violet-700 transition">Adicionar √† Lista</button>
                </form>
            </div>
        );
        
        const AccessForm = ({ newRecordInput, handleInputChange, handleAddItem, mockDepartments }) => {
            const approvalOptions = { 'A': 'Ativo', 'P': 'Pendente', 'R': 'Rejeitado', 'I': 'Inativo' };
            const departmentOptions = Object.values(mockDepartments).map(d => d.DE_NOME_DEPARTAMENTO);
            const leaderOptions = [...new Set(Object.values(mockDepartments).map(d => d.DE_LIDER_DEPTO))];

            return (
                 <div className="mb-8">
                    <h3 className="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4">Grid de Lan√ßamento</h3>
                    <form onSubmit={handleAddItem} className="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label className="block text-sm font-bold mb-1 dark:text-gray-300">Login</label><input type="text" name="AC_LOGIN" value={newRecordInput.AC_LOGIN || ''} onChange={handleInputChange} className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required /></div>
                            <div><label className="block text-sm font-bold mb-1 dark:text-gray-300">Senha</label><input type="password" name="AC_SENHA" value={newRecordInput.AC_SENHA || ''} onChange={handleInputChange} className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required /></div>
                            <div><label className="block text-sm font-bold mb-1 dark:text-gray-300">Departamento</label><select name="AC_DEPARTAMENTO" value={newRecordInput.AC_DEPARTAMENTO || ''} onChange={handleInputChange} className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required><option value="">Selecione...</option>{departmentOptions.map(o => <option key={o} value={o}>{o}</option>)}</select></div>
                            <div><label className="block text-sm font-bold mb-1 dark:text-gray-300">Respons√°vel</label><select name="AC_RESP" value={newRecordInput.AC_RESP || ''} onChange={handleInputChange} className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required><option value="">Selecione...</option>{[...new Set(leaderOptions)].map(o => <option key={o} value={o}>{o}</option>)}</select></div>
                            <div><label className="block text-sm font-bold mb-1 dark:text-gray-300">Email</label><input type="email" name="AC_EMAIL" value={newRecordInput.AC_EMAIL || ''} onChange={handleInputChange} className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required /></div>
                            <div><label className="block text-sm font-bold mb-1 dark:text-gray-300">Aprova√ß√£o</label><select name="AC_APROVACAO" value={newRecordInput.AC_APROVACAO || 'P'} onChange={handleInputChange} className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>{Object.entries(approvalOptions).map(([k, v]) => <option key={k} value={k}>{v}</option>)}</select></div>
                            <div className="md:col-span-2"><label className="block text-sm font-bold mb-1 dark:text-gray-300">Notifica√ß√£o (Ajuda)</label><input type="text" name="AC_NOTIFICACAO" value={newRecordInput.AC_NOTIFICACAO || ''} onChange={handleInputChange} className="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" /></div>
                        </div>
                        <button type="submit" className="w-full bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-violet-700 transition">Adicionar √† Lista</button>
                    </form>
                </div>
            );
        };
        
        const EventTable = ({ records, editingId, editedData, onEditChange, onStartEdit, onCancelEdit, setModalInfo }) => (
            <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead className="bg-gray-100 dark:bg-gray-700 sticky top-0">
                    <tr>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">ID Chave</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Nome do Evento</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Tipo do Evento</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Data Lan√ßamento</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Data Modifica√ß√£o</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Usu√°rio Logado</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {records.map(record => (
                        <tr key={record.RE_ID_EVENTOS}>
                            <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-500 dark:text-gray-400">{record.RE_ID_EVENTOS}</td>
                            {editingId === record.RE_ID_EVENTOS ? (
                                <>
                                    <td className="px-4 py-2"><input type="text" name="EV_NOME_EVENTO" value={editedData.EV_NOME_EVENTO} onChange={onEditChange} className="w-full border-gray-300 rounded-md shadow-sm text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" /></td>
                                    <td className="px-4 py-2"><input type="text" name="EV_TIPO_EVENTO" value={editedData.EV_TIPO_EVENTO} onChange={onEditChange} className="w-full border-gray-300 rounded-md shadow-sm text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" /></td>
                                </>
                            ) : (
                                <>
                                    <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-gray-200">{record.EV_NOME_EVENTO}</td>
                                    <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{record.EV_TIPO_EVENTO}</td>
                                </>
                            )}
                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{record.RE_DATA_UPDATE}</td>
                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{record.RE_DATA_MODIFICACAO}</td>
                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{record.RE_USUARIO_LOGADO}</td>
                            <td className="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                {editingId === record.RE_ID_EVENTOS ? (
                                    <div className="flex gap-2">
                                        <button onClick={() => setModalInfo({isOpen: true, type: 'save', record, title: 'Confirmar Altera√ß√£o', message: 'Deseja salvar as altera√ß√µes neste registro? A modifica√ß√£o ser√° permanente.', confirmText: 'Salvar', confirmColor: 'bg-green-600'})} className="text-green-600 hover:text-green-900">Salvar</button>
                                        <button onClick={onCancelEdit} className="text-gray-600 hover:text-gray-900">Cancelar</button>
                                    </div>
                                ) : (
                                    <div className="flex gap-4">
                                        <button onClick={() => onStartEdit(record)} className="text-violet-600 hover:text-violet-900" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg></button>
                                        <button onClick={() => setModalInfo({isOpen: true, type: 'delete', record, title: 'Confirmar Exclus√£o', message: `Deseja excluir permanentemente o registro "${record.EV_NOME_EVENTO}"?`, confirmText: 'Excluir', confirmColor: 'bg-red-600'})} className="text-red-600 hover:text-red-900" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg></button>
                                    </div>
                                )}
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        );
        
        const DepartmentTable = ({ records, editingId, editedData, onEditChange, onStartEdit, onCancelEdit, setModalInfo }) => (
             <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead className="bg-gray-100 dark:bg-gray-700 sticky top-0">
                    <tr>
                         {['ID Depto', 'Nome', 'L√≠der', 'Associado', 'Contato', 'Anci√£o', 'Email', 'Lan√ßamento', 'Modifica√ß√£o', 'Usu√°rio', 'A√ß√µes'].map(h => <th key={h} className="px-4 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">{h}</th>)}
                    </tr>
                </thead>
                <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {records.map(record => (
                        <tr key={record.DE_ID_DEPTO}>
                            <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-500 dark:text-gray-400">{record.DE_ID_DEPTO}</td>
                            {editingId === record.DE_ID_DEPTO ? (
                                <>
                                    <td><input type="text" name="DE_NOME_DEPARTAMENTO" value={editedData.DE_NOME_DEPARTAMENTO} onChange={onEditChange} className="w-full p-1 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" /></td>
                                    <td><input type="text" name="DE_LIDER_DEPTO" value={editedData.DE_LIDER_DEPTO} onChange={onEditChange} className="w-full p-1 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" /></td>
                                    <td><input type="text" name="DE_ASSOCIADO_DEPTO" value={editedData.DE_ASSOCIADO_DEPTO} onChange={onEditChange} className="w-full p-1 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" /></td>
                                    <td><input type="tel" name="DE_CONTATO" value={editedData.DE_CONTATO} onChange={onEditChange} className="w-full p-1 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" /></td>
                                    <td><input type="text" name="DE_ANCIAO_LIDER" value={editedData.DE_ANCIAO_LIDER} onChange={onEditChange} className="w-full p-1 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" /></td>
                                    <td><input type="email" name="DE_EMAIL" value={editedData.DE_EMAIL} onChange={onEditChange} className="w-full p-1 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" /></td>
                                </>
                            ) : (
                                <>
                                    <td className="px-4 py-3 whitespace-nowrap text-sm dark:text-gray-200">{record.DE_NOME_DEPARTAMENTO}</td>
                                    <td className="px-4 py-3 whitespace-nowrap text-sm dark:text-gray-200">{record.DE_LIDER_DEPTO}</td>
                                    <td className="px-4 py-3 whitespace-nowrap text-sm dark:text-gray-200">{record.DE_ASSOCIADO_DEPTO}</td>
                                    <td className="px-4 py-3 whitespace-nowrap text-sm dark:text-gray-200">{record.DE_CONTATO}</td>
                                    <td className="px-4 py-3 whitespace-nowrap text-sm dark:text-gray-200">{record.DE_ANCIAO_LIDER}</td>
                                    <td className="px-4 py-3 whitespace-nowrap text-sm dark:text-gray-200">{record.DE_EMAIL}</td>
                                </>
                            )}
                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{record.logInfo.RE_DATA_UPDATE}</td>
                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{record.logInfo.RE_DATA_MODIFICACAO}</td>
                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{record.logInfo.RE_USUARIO_LOGADO}</td>
                            <td className="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                 {editingId === record.DE_ID_DEPTO ? (
                                    <div className="flex gap-2">
                                        <button onClick={() => setModalInfo({isOpen: true, type: 'save', record, title: 'Confirmar Altera√ß√£o', message: 'Deseja salvar as altera√ß√µes neste registro? A modifica√ß√£o ser√° permanente.', confirmText: 'Salvar', confirmColor: 'bg-green-600'})} className="text-green-600 hover:text-green-900">Salvar</button>
                                        <button onClick={onCancelEdit} className="text-gray-600 hover:text-gray-900">Cancelar</button>
                                    </div>
                                ) : (
                                    <div className="flex gap-4">
                                        <button onClick={() => onStartEdit(record)} className="text-violet-600 hover:text-violet-900" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg></button>
                                        <button onClick={() => setModalInfo({isOpen: true, type: 'delete', record, title: 'Confirmar Exclus√£o', message: `Deseja excluir permanentemente o departamento "${record.DE_NOME_DEPARTAMENTO}"?`, confirmText: 'Excluir', confirmColor: 'bg-red-600'})} className="text-red-600 hover:text-red-900" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg></button>
                                    </div>
                                )}
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        );
        
        const AccessTable = ({ records, editingId, editedData, onEditChange, onStartEdit, onCancelEdit, setModalInfo, mockDepartments }) => {
            const approvalOptions = { 'A': 'Ativo', 'P': 'Pendente', 'R': 'Rejeitado', 'I': 'Inativo' };
            const departmentOptions = Object.values(mockDepartments).map(d => d.DE_NOME_DEPARTAMENTO);
            const leaderOptions = [...new Set(Object.values(mockDepartments).map(d => d.DE_LIDER_DEPTO))];

            return (
                <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead className="bg-gray-100 dark:bg-gray-700 sticky top-0">
                        <tr>
                            {['ID', 'Login', 'Departamento', 'Respons√°vel', 'Email', 'Aprova√ß√£o', 'Notifica√ß√£o', 'Lan√ßamento', 'Modifica√ß√£o', 'Usu√°rio', 'A√ß√µes'].map(h => 
                                <th key={h} className="px-4 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">{h}</th>)}
                        </tr>
                    </thead>
                    <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        {records.map(record => (
                            <tr key={record.AC_ID}>
                                <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-500 dark:text-gray-400">{record.AC_ID}</td>
                                {editingId === record.AC_ID ? (
                                    <>
                                        <td><input type="text" name="AC_LOGIN" value={editedData.AC_LOGIN} onChange={onEditChange} className="w-full p-1 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" /></td>
                                        <td><select name="AC_DEPARTAMENTO" value={editedData.AC_DEPARTAMENTO} onChange={onEditChange} className="w-full p-1 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="">Selecione</option>{departmentOptions.map(o => <option key={o} value={o}>{o}</option>)}</select></td>
                                        <td><select name="AC_RESP" value={editedData.AC_RESP} onChange={onEditChange} className="w-full p-1 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="">Selecione</option>{leaderOptions.map(o => <option key={o} value={o}>{o}</option>)}</select></td>
                                        <td><input type="email" name="AC_EMAIL" value={editedData.AC_EMAIL} onChange={onEditChange} className="w-full p-1 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" /></td>
                                        <td><select name="AC_APROVACAO" value={editedData.AC_APROVACAO} onChange={onEditChange} className="w-full p-1 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white">{Object.entries(approvalOptions).map(([k,v]) => <option key={k} value={k}>{v}</option>)}</select></td>
                                        <td><input type="text" name="AC_NOTIFICACAO" value={editedData.AC_NOTIFICACAO} onChange={onEditChange} className="w-full p-1 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" /></td>
                                    </>
                                ) : (
                                    <>
                                        <td className="px-4 py-3 whitespace-nowrap text-sm dark:text-gray-200">{record.AC_LOGIN}</td>
                                        <td className="px-4 py-3 whitespace-nowrap text-sm dark:text-gray-200">{record.AC_DEPARTAMENTO}</td>
                                        <td className="px-4 py-3 whitespace-nowrap text-sm dark:text-gray-200">{record.AC_RESP}</td>
                                        <td className="px-4 py-3 whitespace-nowrap text-sm dark:text-gray-200">{record.AC_EMAIL}</td>
                                        <td className="px-4 py-3 whitespace-nowrap text-sm"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${record.AC_APROVACAO === 'A' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300'}`}>{approvalOptions[record.AC_APROVACAO]}</span></td>
                                        <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 max-w-xs truncate">{record.AC_NOTIFICACAO}</td>
                                    </>
                                )}
                                <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{record.logInfo.RE_DATA_UPDATE}</td>
                                <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{record.logInfo.RE_DATA_MODIFICACAO}</td>
                                <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{record.logInfo.RE_USUARIO_LOGADO}</td>
                                <td className="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                     {editingId === record.AC_ID ? (
                                        <div className="flex gap-2">
                                            <button onClick={() => setModalInfo({isOpen: true, type: 'save', record, title: 'Confirmar Altera√ß√£o', message: 'Deseja salvar as altera√ß√µes neste registro? A modifica√ß√£o ser√° permanente.', confirmText: 'Salvar', confirmColor: 'bg-green-600'})} className="text-green-600 hover:text-green-900">Salvar</button>
                                            <button onClick={onCancelEdit} className="text-gray-600 hover:text-gray-900">Cancelar</button>
                                        </div>
                                    ) : (
                                        <div className="flex gap-4">
                                            <button onClick={() => onStartEdit(record)} className="text-violet-600 hover:text-violet-900" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg></button>
                                            <button onClick={() => setModalInfo({isOpen: true, type: 'delete', record, title: 'Confirmar Exclus√£o', message: `Deseja excluir permanentemente o acesso do usu√°rio "${record.AC_LOGIN}"?`, confirmText: 'Excluir', confirmColor: 'bg-red-600'})} className="text-red-600 hover:text-red-900" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg></button>
                                        </div>
                                    )}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            );
        }


 // --- Componente Principal App Completo ---
// --- Componente Principal ---
        function App() {
            // --- ESTADOS DE USU√ÅRIO E NAVEGA√á√ÉO ---
            const handleEditCalendarEvent = (event) => {
    setEditingCalendarEvent(event);
    setView('addCalendarEvent');
};
            const [mockBranches, setMockBranches] = useState([]);
            const [currentUser, setCurrentUser] = useState(null);
            const [view, setView] = useState('login'); 
            const [selectedEventId, setSelectedEventId] = useState(null);
            const [editingEventId, setEditingEventId] = useState(null);
            const [loading, setLoading] = useState(true);
            
            // --- ESTADOS DE DADOS (BACKEND) ---
            const [mockEvents, setMockEvents] = useState([]); // Eventos vindos da planilha
            // Mantemos os est√°ticos como fallback ou inicializa√ß√£o se necess√°rio, mas idealmente viriam do back
            const [mockScales, setMockScales] = useState(MOCK_SCALES_DATA); 
            const [assignments, setAssignments] = useState(MOCK_ASSIGNMENTS);
            const [mockDepartments, setMockDepartments] = useState({});
            const [mockAccess, setMockAccess] = useState({});
            
            // --- ESTADOS DE INTERFACE ---
            const [managingTable, setManagingTable] = useState(null);
            const [theme, setTheme] = useState('light');
            const [showNotifications, setShowNotifications] = useState(false); // <--- NOVO: Controle do Modal de Avisos

            // --- EFEITOS (SIDE EFFECTS) ---

            // 1. Gerenciamento de Tema (Dark Mode)
            useEffect(() => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [theme]);

            // 2. Carregamento Inicial de Dados (Ao abrir o App)
            useEffect(() => {
                const loadData = async () => {
                    try {
                        const data = await api.getInitialData();
                        
                        if (data) {
                            if (data.eventos) setMockEvents(data.eventos);
                            
                            // --- ADICIONADO: Carrega as Escalas Reais ---
                            if (data.escalas) setMockScales(data.escalas);
                            
                            if (data.departamentos) {
                                // Converte array de strings em objeto para f√°cil acesso
                                const deptsObj = {};
                                data.departamentos.forEach(d => deptsObj[d] = { DE_NOME_DEPARTAMENTO: d });
                                setMockDepartments(deptsObj);
                            }
                            if (data.filiais) setMockBranches(data.filiais);
                            // Se o backend devolver sess√£o ativa (opcional futuro), restaura login
                            if (data.currentUser && data.currentUser.id !== 'guest') {
                                setCurrentUser(data.currentUser);
                                setView('dashboard');
                            }
                        }
                    } catch (error) {
                        console.error("Erro ao carregar dados iniciais:", error);
                    } finally {
                        setLoading(false); // Libera a tela de loading
                    }
                };
                loadData();
            }, []);
            
            // 3. Configura√ß√£o do Manifesto PWA (√çcone na home do celular)
            useEffect(() => {
                const manifest = {
                    "name": "Agendei7", "short_name": "Agendei7", "start_url": ".", "display": "standalone",
                    "background_color": "#f3f4f6", "theme_color": "#6d28d9", "description": "Aplicativo para agendamento de escalas da igreja.", "icons": []
                };
                const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestUrl = URL.createObjectURL(blob);
                document.querySelector('#manifest').setAttribute('href', manifestUrl);
            }, []);

            // --- HANDLERS (FUN√á√ïES DE A√á√ÉO) ---

            const refreshData = async () => {
                    setLoading(true);
                    try {
                        const data = await api.getInitialData();
                        if (data && data.eventos) setMockEvents(data.eventos);
                        setView('dashboard');
                    } catch (e) {
                        console.error(e);
                    } finally {
                        setLoading(false);
                    }
                };

            const handleLogin = (userData) => {
                setCurrentUser(userData);
                setView('dashboard');
            };

            const handleLogout = () => {
                setLoading(true);
                setTimeout(() => {
                    setCurrentUser(null); 
                    setView('login'); 
                    setLoading(false);
                }, 500);
            };

            const handleUpdateUser = (updatedUser) => {
                 setCurrentUser(updatedUser);
            };

            const handleUpdatePassword = (newPassword) => {
                alert("A altera√ß√£o de senha deve ser solicitada ao administrador.");
            }

            // --- RENDERIZA√á√ÉO ---

            if (loading) {
                return ( <div className="min-h-screen flex justify-center items-center"> <div className="loader"></div> </div> );
            }

            const renderView = () => {
                // Se n√£o estiver logado, mostra Login (passando deptos para n√£o travar)
                if (!currentUser) {
                    return <LoginPage onLogin={handleLogin} initialDepartments={Object.keys(mockDepartments)} />;
                }
                
                // Roteador de Telas
                switch (view) {
                    case 'dashboard': 
                        return <DashboardPage 
                            currentUser={currentUser} 
                            setView={setView} 
                            setEventId={setSelectedEventId} 
                            mockEvents={mockEvents} 
                            // Passa a fun√ß√£o que abre o modal ao clicar no sino
                            onOpenNotifications={() => setShowNotifications(true)} 
                            onEditEvent={handleEditCalendarEvent}
                        />;
                        case 'addCalendarEvent':
                          return <AddCalendarEventPage 
                            setView={setView} onSaveSuccess={refreshData}
                            branches={mockBranches || []}
                            editingEvent={editingCalendarEvent}
                        />;
                    case 'addEvent': 
                        return <AddEventPage 
                            setView={setView} 
                            setMockEvents={setMockEvents} 
                            mockEvents={mockEvents} 
                            editingEventId={editingEventId} 
                            setEditingEventId={setEditingEventId} 
                        />;
                    case 'editScales': 
                        return <EditScalesPage 
                            setView={setView} 
                            mockEvents={mockEvents} 
                            setMockEvents={setMockEvents} 
                            setEditingEventId={setEditingEventId} 
                        />;
                    case 'generateRoteiro': 
                        return <GenerateRoteiroPage 
                            setView={setView} 
                            mockEvents={mockEvents} 
                            mockDepartments={mockDepartments} 
                        />;
                    case 'eventDetail': 
                        return <EventDetailPage 
                            currentUser={currentUser} 
                            eventId={selectedEventId} 
                            setView={setView} 
                            assignments={assignments} 
                            setAssignments={setAssignments} 
                            mockEvents={mockEvents} 
                            mockScales={mockScales} 
                        />;
                    case 'calendar': 
                        return <CalendarPage 
                            currentUser={currentUser} 
                            setView={setView} 
                            setEventId={setSelectedEventId} 
                            mockEvents={mockEvents} 
                        />;
                    case 'profile': 
                        return <ProfilePage 
                            currentUser={currentUser} 
                            onLogout={handleLogout} 
                            onUpdateUser={handleUpdateUser} 
                            setView={setView} 
                        />;
                    case 'myScales': 
                        return <MyScalesPage 
                            currentUser={currentUser} 
                            mockEvents={mockEvents} 
                            setView={setView} 
                        />;
                    case 'departmentData': 
                        return <DepartmentDataPage setView={setView} />;
                    case 'settings': 
                        return <SettingsPage 
                            currentUser={currentUser} 
                            setView={setView} 
                            setManagingTable={setManagingTable} 
                            theme={theme} 
                            setTheme={setTheme} 
                            onUpdatePassword={handleUpdatePassword} 
                        />;
                    case 'manageTable': 
                        return <ManageTablePage 
                            tableName={managingTable} 
                            setView={setView} 
                            mockEvents={mockEvents} 
                            currentUser={currentUser} 
                            setMockEvents={setMockEvents} 
                            mockDepartments={mockDepartments} 
                            setMockDepartments={setMockDepartments} 
                            mockAccess={mockAccess} 
                            setMockAccess={setMockAccess} 
                        />;
                    default: 
                        return <DashboardPage 
                            currentUser={currentUser} 
                            setView={setView} 
                            setEventId={setSelectedEventId} 
                            mockEvents={mockEvents} 
                            onOpenNotifications={() => setShowNotifications(true)}
                        />;
                }
            };
            
            const showNav = currentUser && view !== 'login';

            return (
                <div className="bg-gray-100 dark:bg-gray-900 min-h-screen relative">
                    {/* 1. Renderiza a tela atual */}
                    {renderView()}
                    
                    {/* 2. Renderiza o Modal de Notifica√ß√µes (Fica "por cima" de tudo) */}
                    <NotificationCenterModal 
                        isOpen={showNotifications} 
                        onClose={() => setShowNotifications(false)} 
                        mockDepartments={mockDepartments}
                    />

                    {/* 3. Renderiza o Menu Inferior */}
                    {showNav && <BottomNav activeView={view} setView={setView} />}
                </div>
            );
        }


        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
